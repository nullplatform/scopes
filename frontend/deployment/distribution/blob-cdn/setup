#!/bin/bash

echo "ðŸ” Validating Azure CDN distribution configuration..."

application_slug=$(echo "$CONTEXT" | jq -r .application.slug)
scope_slug=$(echo "$CONTEXT" | jq -r .scope.slug)
scope_id=$(echo "$CONTEXT" | jq -r .scope.id)
asset_url=$(echo "$CONTEXT" | jq -r .asset.url)

distribution_app_name="$application_slug-$scope_slug-$scope_id"
echo "   âœ… app_name=$distribution_app_name"

echo ""
echo "   ðŸ“¡ Fetching assets-repository provider..."

nrn=$(echo "$CONTEXT" | jq -r .scope.nrn)

asset_repository=$(np provider list --nrn "$nrn" --categories assets-repository --format json 2>&1)
np_exit_code=$?

echo $asset_repository | jq .

if [ $np_exit_code -ne 0 ]; then
  echo ""
  echo "   âŒ Failed to fetch assets-repository provider"
  echo ""

  if echo "$asset_repository" | grep -q "unauthorized\|forbidden\|401\|403"; then
    echo "  ðŸ”’ Error: Permission denied"
    echo ""
    echo "  ðŸ’¡ Possible causes:"
    echo "    â€¢ The nullplatform API Key doesn't have 'Ops' permissions at nrn: $nrn"
    echo ""
    echo "  ðŸ”§ How to fix:"
    echo "    1. Ensure the API Key has 'Ops' permissions at the correct NRN hierarchy level"

  else
    echo "  ðŸ“‹ Error details:"
    echo "$asset_repository" | sed 's/^/    /'
  fi

  echo ""
  exit 1
fi

# Look for Azure Blob Storage provider (storage_account and container)
distribution_storage_account=$(echo "$asset_repository" | jq -r '
  [.results[] | select(.attributes.storage_account.name != null)] | first | .attributes.storage_account.name // empty
')

distribution_container_name=$(echo "$asset_repository" | jq -r '
  [.results[] | select(.attributes.container.name != null)] | first | .attributes.container.name // empty
')

if [ -z "$distribution_storage_account" ] || [ "$distribution_storage_account" = "null" ]; then
  echo ""
  echo "   âŒ No assets-repository provider of type Azure Blob Storage at nrn: $nrn"
  echo ""

  provider_count=$(echo "$asset_repository" | jq '.results | length')

  if [ "$provider_count" -gt 0 ]; then
    echo "  ðŸ¤” Found $provider_count asset-repository provider(s), but none are configured for Azure Blob Storage."
    echo ""
    echo "  ðŸ“‹ Verify the existing providers with the nullplatform CLI:"
    echo "$asset_repository" | jq -r '.results[] | "    â€¢ np provider read --id \(.id) --format json"' 2>/dev/null
    echo ""
  fi

  echo "  ðŸ”§ How to fix:"
  echo "    1. Ensure there is an asset-repository provider of type Azure Blob Storage configured at the correct NRN hierarchy level"
  echo ""
  exit 1
fi

echo "   âœ… storage_account=$distribution_storage_account"
echo "   âœ… container=${distribution_container_name:-"\$web"}"

# Set default container to $web if not specified (Azure static website container)
distribution_container_name=${distribution_container_name:-"\$web"}

# Blob path prefix for multi-scope storage support
# Extract path from asset_url (supports https:// format)
# Removes protocol and storage account/container prefix, keeps the path with leading slash
if [[ "$asset_url" == https://* ]]; then
  # Extract path after the container name
  distribution_blob_prefix="/${asset_url#https://*/*/}"
else
  distribution_blob_prefix="/"
fi

# Normalize empty prefix to just "/"
if [ "$distribution_blob_prefix" = "/" ] || [ -z "$distribution_blob_prefix" ]; then
  distribution_blob_prefix="/"
fi

echo "   âœ… blob_prefix=${distribution_blob_prefix:-"(root)"}"

RESOURCE_TAGS_JSON=${RESOURCE_TAGS_JSON:-"{}"}

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg storage_account "$distribution_storage_account" \
  --arg container_name "$distribution_container_name" \
  --arg app_name "$distribution_app_name" \
  --argjson resource_tags_json "$RESOURCE_TAGS_JSON" \
  --arg blob_prefix "$distribution_blob_prefix" \
  '. + {
    distribution_storage_account: $storage_account,
    distribution_container_name: $container_name,
    distribution_app_name: $app_name,
    distribution_blob_prefix: $blob_prefix,
    distribution_resource_tags_json: $resource_tags_json
  }')

echo ""
echo "âœ¨ Azure CDN distribution configured successfully"
echo ""

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
