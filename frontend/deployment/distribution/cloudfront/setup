#!/bin/bash

echo "ðŸ” Validating CloudFront distribution configuration..."

application_slug=$(echo "$CONTEXT" | jq -r .application.slug)
scope_slug=$(echo "$CONTEXT" | jq -r .scope.slug)
scope_id=$(echo "$CONTEXT" | jq -r .scope.id)

distribution_app_name="$application_slug-$scope_slug-$scope_id"
echo "   âœ… app_name=$distribution_app_name"

echo ""
echo "   ðŸ“¡ Fetching assets-repository provider..."

nrn=$(echo "$CONTEXT" | jq -r .scope.nrn)

asset_repository=$(np provider list --nrn "$nrn" --categories assets-repository --format json 2>&1)
np_exit_code=$?

if [ $np_exit_code -ne 0 ]; then
  echo ""
  echo "   âŒ Failed to fetch assets-repository provider"
  echo ""

  if echo "$asset_repository" | grep -q "not found\|no providers"; then
    echo "  ðŸ”Ž Error: No assets-repository provider found"
    echo ""
    echo "  ðŸ’¡ Possible causes:"
    echo "    â€¢ No assets-repository provider is configured for this scope"
    echo "    â€¢ The provider category 'assets-repository' fes not exist"
    echo ""
    echo "  ðŸ”§ How to fix:"
    echo "    1. Create an assets-repository provider in nullplatform"
    echo "    2. Ensure it's linked to the scope with NRN: $nrn"

  elif echo "$asset_repository" | grep -q "unauthorized\|forbidden\|401\|403"; then
    echo "  ðŸ”’ Error: Permission denied"
    echo ""
    echo "  ðŸ’¡ Possible causes:"
    echo "    â€¢ The API token doesn't have permission to list providers"
    echo "    â€¢ The token has expired"
    echo ""
    echo "  ðŸ”§ How to fix:"
    echo "    1. Check your NP_API_KEY is set and valid"
    echo "    2. Ensure you have permissions to access providers"

  elif echo "$asset_repository" | grep -q "command not found"; then
    echo "  âš ï¸  Error: 'np' CLI not found"
    echo ""
    echo "  ðŸ”§ How to fix:"
    echo "    Install the nullplatform CLI: npm install -g @nullplatform/cli"

  else
    echo "  ðŸ“‹ Error details:"
    echo "$asset_repository" | sed 's/^/    /'
  fi

  echo ""
  exit 1
fi

distribution_bucket_name=$(echo "$asset_repository" | jq -r '
  [.results[] | select(.attributes.bucket.name != null)] | first | .attributes.bucket.name // empty
')

if [ -z "$distribution_bucket_name" ] || [ "$distribution_bucket_name" = "null" ]; then
  echo ""
  echo "   âŒ No S3 bucket found in assets-repository providers"
  echo ""
  echo "  ðŸ¤” Found $(echo "$asset_repository" | jq '.results | length') provider(s), but none contain bucket information"
  echo ""
  echo "  ðŸ“‹ Providers found:"
  echo "$asset_repository" | jq -r '.results[] | "    â€¢ \(.name // .id // "unnamed") (type: \(.type // "unknown"))"' 2>/dev/null || echo "    (could not parse providers)"
  echo ""
  echo "  ðŸ’¡ Expected one provider with: attributes.bucket.name"
  echo ""
  echo "  ðŸ”§ How to fix:"
  echo "    1. Ensure an S3 bucket provider is configured in assets-repository category"
  echo "    2. Verify the provider has the bucket_name attribute populated"
  echo ""
  exit 1
fi

echo "   âœ… bucket_name=$distribution_bucket_name"

# S3 prefix for multi-scope bucket support
# TODO: Replace with your prefix variable
distribution_s3_prefix="/app"

echo "   âœ… s3_prefix=${distribution_s3_prefix:-"(root)"}"

RESOURCE_TAGS_JSON=${RESOURCE_TAGS_JSON:-"{}"}

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg bucket_name "$distribution_bucket_name" \
  --arg app_name "$distribution_app_name" \
  --argjson resource_tags_json "$RESOURCE_TAGS_JSON" \
  --arg s3_prefix "$distribution_s3_prefix" \
  '. + {
    distribution_bucket_name: $bucket_name,
    distribution_app_name: $app_name,
    distribution_s3_prefix: $s3_prefix,
    distribution_resource_tags_json: $resource_tags_json
  }')

echo ""
echo "âœ¨ CloudFront distribution configured successfully"
echo ""

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
