#!/bin/bash

# GCS + Cloud CDN Hosting Setup

hosting_app_name=$(echo "$TOFU_VARIABLES" | jq -r '.application_slug')
hosting_environment=$(echo "$TOFU_VARIABLES" | jq -r '.scope_slug // "prod"')
hosting_project_id=$(echo "$TOFU_VARIABLES" | jq -r '.gcp_provider.project // empty')
hosting_region=$(echo "$TOFU_VARIABLES" | jq -r '.gcp_provider.region // "us-central1"')

if [ -z "$hosting_project_id" ]; then
  echo "âœ— GCP project not configured. Run tofu_state/gcp setup first."
  exit 1
fi

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg app_name "$hosting_app_name" \
  --arg environment "$hosting_environment" \
  --arg project_id "$hosting_project_id" \
  --arg region "$hosting_region" \
  '. + {
    hosting_app_name: $app_name,
    hosting_environment: $environment,
    hosting_project_id: $project_id,
    hosting_region: $region
  }')

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir#*deployment/}"
MODULES_TO_USE="${MODULES_TO_USE:+$MODULES_TO_USE,}$module_name"
