#!/bin/bash

hosted_zone_id=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].networking.hosted_public_zone_id // empty')

if [ -z "$hosted_zone_id" ]; then
  echo "‚ùå hosted_public_zone_id is not set in context"
  exit 1
fi

application_slug=$(echo "$CONTEXT" | jq -r .application.slug)
scope_slug=$(echo "$CONTEXT" | jq -r .scope.slug)

# Fetch the domain name from Route 53 hosted zone
echo "üîç Fetching domain from Route 53 hosted zone: $hosted_zone_id"

aws_output=$(aws route53 get-hosted-zone --id "$hosted_zone_id" 2>&1)
aws_exit_code=$?

if [ $aws_exit_code -ne 0 ]; then
  echo ""
  echo "‚ùå Failed to fetch Route 53 hosted zone information"
  echo ""

  if echo "$aws_output" | grep -q "NoSuchHostedZone"; then
    echo "  üîé Error: Hosted zone '$hosted_zone_id' does not exist"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The hosted zone ID is incorrect or has a typo"
    echo "    ‚Ä¢ The hosted zone was deleted"
    echo "    ‚Ä¢ The hosted zone ID format is wrong (should be like 'Z1234567890ABC' or '/hostedzone/Z1234567890ABC')"
    echo ""
    echo "  üîß How to fix:"
    echo "    1. Verify the hosted zone exists: aws route53 list-hosted-zones"
    echo "    2. Update 'hosted_public_zone_id' in your cloud provider configuration"

  elif echo "$aws_output" | grep -q "AccessDenied\|not authorized"; then
    echo "  üîí Error: Permission denied when accessing Route 53"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The AWS credentials don't have Route 53 read permissions"
    echo "    ‚Ä¢ The IAM role/user is missing the 'route53:GetHostedZone' permission"
    echo ""
    echo "  üîß How to fix:"
    echo "    1. Check your AWS credentials are configured correctly"
    echo "    2. Ensure your IAM policy includes:"
    echo "       {"
    echo "         \"Effect\": \"Allow\","
    echo "         \"Action\": \"route53:GetHostedZone\","
    echo "         \"Resource\": \"arn:aws:route53:::hostedzone/$hosted_zone_id\""
    echo "       }"

  elif echo "$aws_output" | grep -q "InvalidInput"; then
    echo "  ‚ö†Ô∏è  Error: Invalid hosted zone ID format"
    echo ""
    echo "  The hosted zone ID '$hosted_zone_id' is not valid."
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Use the format 'Z1234567890ABC' or '/hostedzone/Z1234567890ABC'"
    echo "    ‚Ä¢ Find valid zone IDs with: aws route53 list-hosted-zones"

  elif echo "$aws_output" | grep -q "Unable to locate credentials\|ExpiredToken\|InvalidClientTokenId"; then
    echo "  üîë Error: AWS credentials issue"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ AWS credentials are not configured"
    echo "    ‚Ä¢ AWS credentials have expired"
    echo "    ‚Ä¢ AWS_ACCESS_KEY_ID or AWS_SECRET_ACCESS_KEY environment variables are missing"
    echo ""
    echo "  üîß How to fix:"
    echo "    1. Run 'aws configure' to set up credentials"
    echo "    2. Or set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environment variables"
    echo "    3. If using temporary credentials, refresh your session token"

  else
    echo "  üìã Error details:"
    echo "$aws_output" | sed 's/^/    /'
  fi

  echo ""
  exit 1
fi

network_domain=$(echo "$aws_output" | jq -r '.HostedZone.Name' | sed 's/\.$//')

if [ -z "$network_domain" ] || [ "$network_domain" = "null" ]; then
  echo ""
  echo "‚ùå Failed to extract domain name from hosted zone response"
  echo ""
  echo "  ü§î The AWS API returned successfully but the domain name could not be parsed."
  echo "  This is unexpected - please check the hosted zone configuration."
  echo ""
  exit 1
fi

echo "‚úÖ Domain resolved: $network_domain"

network_subdomain="$application_slug-$scope_slug"
echo "‚úÖ Subdomain: $network_subdomain"

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg hosted_zone_id "$hosted_zone_id" \
  --arg domain "$network_domain" \
  --arg subdomain "$network_subdomain" \
  '. + {
    network_hosted_zone_id: $hosted_zone_id,
    network_domain: $domain,
    network_subdomain: $subdomain
  }')

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
