#!/bin/bash

echo "üîç Validating Azure DNS network configuration..."

public_dns_zone_name=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].networking.public_dns_zone_name // empty')

if [ -z "$public_dns_zone_name" ]; then
  echo ""
  echo "   ‚ùå public_dns_zone_name is not set in context"
  echo ""
  echo "  üîß How to fix:"
  echo "    ‚Ä¢ Ensure there is an Azure cloud-provider configured at the correct NRN hierarchy level"
  echo "    ‚Ä¢ Set the 'public_dns_zone_name' field with the Azure DNS zone name"
  echo ""
  exit 1
fi
echo "   ‚úÖ public_dns_zone_name=$public_dns_zone_name"

application_slug=$(echo "$CONTEXT" | jq -r .application.slug)
scope_slug=$(echo "$CONTEXT" | jq -r .scope.slug)
scope_id=$(echo "$CONTEXT" | jq -r .scope.id)
public_dns_zone_resource_group_name=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].networking.public_dns_zone_resource_group_name // empty')

if [ -z "$public_dns_zone_resource_group_name" ]; then
  echo ""
  echo "   ‚ùå public_dns_zone_resource_group_name is not set in context"
  echo ""
  echo "  üîß How to fix:"
  echo "    ‚Ä¢ Ensure the Azure cloud-provider has 'public_dns_zone_resource_group_name' configured"
  echo ""
  exit 1
fi
echo "   ‚úÖ public_dns_zone_resource_group_name=$public_dns_zone_resource_group_name"

echo ""
echo "   üì° Verifying Azure DNS zone..."

az_output=$(az network dns zone show --name "$public_dns_zone_name" --resource-group "$public_dns_zone_resource_group_name" 2>&1)
az_exit_code=$?

if [ $az_exit_code -ne 0 ]; then
  echo ""
  echo "   ‚ùå Failed to fetch Azure DNS zone information"
  echo ""

  if echo "$az_output" | grep -q "ResourceNotFound\|NotFound"; then
    echo "  üîé Error: DNS zone '$public_dns_zone_name' does not exist in resource group '$public_dns_zone_resource_group_name'"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The DNS zone name is incorrect or has a typo"
    echo "    ‚Ä¢ The DNS zone was deleted"
    echo "    ‚Ä¢ The resource group is incorrect"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Verify the DNS zone exists: az network dns zone list --resource-group $public_dns_zone_resource_group_name"
    echo "    ‚Ä¢ Update 'public_dns_zone_name' in the Azure cloud-provider configuration"

  elif echo "$az_output" | grep -q "AuthorizationFailed\|Forbidden\|403"; then
    echo "  üîí Error: Permission denied when accessing Azure DNS"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The Azure credentials don't have DNS Zone read permissions"
    echo "    ‚Ä¢ The service principal is missing the 'DNS Zone Contributor' role"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Check the Azure credentials are configured correctly"
    echo "    ‚Ä¢ Ensure the service principal has 'DNS Zone Reader' or 'DNS Zone Contributor' role"

  elif echo "$az_output" | grep -q "InvalidSubscriptionId\|SubscriptionNotFound"; then
    echo "  ‚ö†Ô∏è  Error: Invalid subscription"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Verify the Azure subscription is correct"
    echo "    ‚Ä¢ Check the service principal has access to the subscription"

  elif echo "$az_output" | grep -q "AADSTS\|InvalidAuthenticationToken\|ExpiredAuthenticationToken"; then
    echo "  üîë Error: Azure credentials issue"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The nullplatform agent is not configured with Azure credentials"
    echo "    ‚Ä¢ The service principal credentials have expired"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Configure Azure credentials in the nullplatform agent"
    echo "    ‚Ä¢ Verify the service principal credentials are valid"

  else
    echo "  üìã Error details:"
    echo "$az_output" | sed 's/^/    /'
  fi

  echo ""
  exit 1
fi

network_domain=$(echo "$az_output" | jq -r '.name')

if [ -z "$network_domain" ] || [ "$network_domain" = "null" ]; then
  echo ""
  echo "   ‚ùå Failed to extract domain name from DNS zone response"
  echo ""
  echo "  üí° Possible causes:"
  echo "    ‚Ä¢ The DNS zone does not have a valid domain name configured"
  echo ""
  echo "  üîß How to fix:"
  echo "    ‚Ä¢ Verify the DNS zone has a valid domain: az network dns zone show --name $public_dns_zone_name --resource-group $public_dns_zone_resource_group_name"
  echo ""
  exit 1
fi

echo "   ‚úÖ domain=$network_domain"

network_subdomain="$application_slug-$scope_slug"
echo "   ‚úÖ subdomain=$network_subdomain"

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg dns_zone_name "$public_dns_zone_name" \
  --arg domain "$network_domain" \
  --arg subdomain "$network_subdomain" \
  '. + {
    network_dns_zone_name: $dns_zone_name,
    network_domain: $domain,
    network_subdomain: $subdomain
  }')

scope_domain="$network_subdomain.$network_domain"

echo ""
echo "   üìù Setting scope domain to '$scope_domain'..."

np_output=$(np scope patch --id "$scope_id" --body "{\"domain\":\"$scope_domain\"}" --format json 2>&1)
np_exit_code=$?

if [ $np_exit_code -ne 0 ]; then
  echo ""
  echo "   ‚ùå Failed to update scope domain"
  echo ""

  if echo "$np_output" | grep -q "unauthorized\|forbidden\|401\|403"; then
    echo "  üîí Error: Permission denied"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The nullplatform API Key doesn't have 'Developer' permissions"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Ensure the API Key has 'Developer' permissions at the correct NRN hierarchy level"

  else
    echo "  üìã Error details:"
    echo "$np_output" | sed 's/^/    /'
  fi

  echo ""
  exit 1
fi

echo "   ‚úÖ Scope domain set successfully"

echo ""
echo "‚ú® Azure DNS network configured successfully"
echo ""

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
