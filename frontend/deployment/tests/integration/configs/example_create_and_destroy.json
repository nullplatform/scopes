{
  "name": "Create and destroy CloudFront distribution",
  "description": "Tests the full lifecycle: create infrastructure, verify it exists, then destroy it",
  "context_file": "resources/context.json",
  "setup": [
    "aws s3api create-bucket --bucket assets-bucket",
    "aws s3api create-bucket --bucket tofu-state-bucket",
    "aws dynamodb create-table --table-name tofu-locks --attribute-definitions AttributeName=LockID,AttributeType=S --key-schema AttributeName=LockID,KeyType=HASH --billing-mode PAY_PER_REQUEST",
    "aws route53 create-hosted-zone --name frontend.publicdomain.com --caller-reference public-zone-id"
  ],
  "context_overrides": {
    "providers.cloud-providers.networking.hosted_public_zone_id": "$(aws route53 list-hosted-zones --query 'HostedZones[0].Id' --output text | sed 's|/hostedzone/||')"
  },
  "steps": [
    {
      "name": "create_infrastructure",
      "workflow": "$PROJECT_DIR/workflows/initial.yaml",
      "env": {
        "CUSTOM_TOFU_MODULES": "$INTEGRATION_TEST_DIR/localstack",
        "SERVICE_PATH": "$PROJECT_DIR/..",
        "NETWORK_LAYER": "route53",
        "DISTRIBUTION_LAYER": "cloudfront",
        "TOFU_PROVIDER": "aws",
        "TOFU_PROVIDER_BUCKET": "tofu-state-bucket",
        "TOFU_LOCK_TABLE": "tofu-locks",
        "AWS_REGION": "us-east-1"
      },
      "np_mocks": {
        "np provider list": {
          "response_file": "asset_repository_success.json",
          "exit_code": 0
        },
        "np scope get": {
          "response_file": "scope_success.json",
          "exit_code": 0
        }
      },
      "assertions": [
        {
          "type": "s3_bucket_exists",
          "bucket": "assets-bucket"
        },
        {
          "type": "cloudfront_distribution_exists",
          "comment": "Distribution for automation-development-tools-7"
        },
        {
          "type": "route53_record_exists",
          "name": "automation-development-tools.frontend.publicdomain.com",
          "record_type": "A"
        }
      ]
    },
    {
      "name": "destroy_infrastructure",
      "before": [
        "$INTEGRATION_TEST_DIR/scripts/disable_cloudfront.sh 'Distribution for automation-development-tools-7'"
      ],
      "workflow": "$PROJECT_DIR/workflows/delete.yaml",
      "env": {
        "CUSTOM_TOFU_MODULES": "$INTEGRATION_TEST_DIR/localstack",
        "SERVICE_PATH": "$PROJECT_DIR/..",
        "NETWORK_LAYER": "route53",
        "DISTRIBUTION_LAYER": "cloudfront",
        "TOFU_PROVIDER": "aws",
        "TOFU_PROVIDER_BUCKET": "tofu-state-bucket",
        "TOFU_LOCK_TABLE": "tofu-locks",
        "AWS_REGION": "us-east-1"
      },
      "np_mocks": {
        "np provider list": {
          "response_file": "asset_repository_success.json",
          "exit_code": 0
        },
        "np scope get": {
          "response_file": "scope_success.json",
          "exit_code": 0
        }
      },
      "assertions": [
        {
          "type": "s3_bucket_exists",
          "bucket": "assets-bucket"
        },
        {
          "type": "cloudfront_distribution_not_exists",
          "comment": "Distribution for automation-development-tools-7"
        },
        {
          "type": "route53_record_not_exists",
          "name": "automation-development-tools.frontend.publicdomain.com",
          "record_type": "A"
        }
      ]
    }
  ]
}
