#!/bin/bash

# Compose Terraform modules dynamically
# Usage: source compose_modules
#
# Required environment variables:
#   MODULES_TO_USE  - Comma-separated list of modules (e.g., "state/aws,network/route_53,hosting/amplify")
#   TOFU_MODULE_DIR - Target directory where .tf files will be copied
#
# Each module can have:
#   - *.tf files: Copied to TOFU_MODULE_DIR (Terraform auto-merges all .tf files)
#   - setup script: Sourced to configure TOFU_VARIABLES and TOFU_INIT_VARIABLES

script_dir="$(dirname "${BASH_SOURCE[0]}")"
modules_dir="$script_dir"

echo "üîç Validating module composition configuration..."

if [ -z "${MODULES_TO_USE:-}" ]; then
  echo ""
  echo "   ‚ùå MODULES_TO_USE is not set"
  echo ""
  echo "  üîß How to fix:"
  echo "    ‚Ä¢ Ensure MODULES_TO_USE is set before calling compose_modules"
  echo "    ‚Ä¢ This is typically done by the setup scripts (provider, network, distribution)"
  echo ""
  exit 1
fi

if [ -z "${TOFU_MODULE_DIR:-}" ]; then
  echo ""
  echo "   ‚ùå TOFU_MODULE_DIR is not set"
  echo ""
  echo "  üîß How to fix:"
  echo "    ‚Ä¢ Ensure TOFU_MODULE_DIR is set before calling compose_modules"
  echo "    ‚Ä¢ This is typically done by the build_context script"
  echo ""
  exit 1
fi

mkdir -p "$TOFU_MODULE_DIR"

echo "   ‚úÖ modules=$MODULES_TO_USE"
echo "   ‚úÖ target=$TOFU_MODULE_DIR"
echo ""

IFS=',' read -ra modules <<< "$MODULES_TO_USE"
for module in "${modules[@]}"; do
  module=$(echo "$module" | xargs) # trim whitespace

  if [ ! -d "$module" ]; then
    echo "   ‚ùå Module directory not found: $module"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Verify the module path is correct and the directory exists"
    echo ""
    exit 1
  fi

  echo "üì¶ $module"

  # Copy .tf files if they exist (with module prefix to avoid conflicts)
  if ls "$module"/*.tf 1> /dev/null 2>&1; then
    # Extract last two path components for prefix (e.g., "/path/to/state/aws" -> "state_aws_")
    parent=$(basename "$(dirname "$module")")
    leaf=$(basename "$module")
    prefix="${parent}_${leaf}_"

    copied_files=()
    for tf_file in "$module"/*.tf; do
      filename=$(basename "$tf_file")
      # Skip test-only files (test_*.tf)
      if [[ "$filename" == test_*.tf ]]; then
        continue
      fi
      cp "$tf_file" "$TOFU_MODULE_DIR/${prefix}${filename}"
      copied_files+=("$filename")
    done

    for file in "${copied_files[@]}"; do
      echo "   $file"
    done
    echo "   ‚úÖ Copied ${#copied_files[@]} file(s) with prefix: $prefix"
  fi

  # Source setup script if it exists
  if [ -f "$module/setup" ]; then
    echo "   üì° Running setup script..."
    source "$module/setup"
    if [ $? -ne 0 ]; then
      echo ""
      echo "   ‚ùå Setup script failed for module: $module"
      echo ""
      exit 1
    fi
    echo "   ‚úÖ Setup completed"
  fi

  echo ""
done

echo "‚ú® All modules composed successfully"