#!/bin/bash
# =============================================================================
# Layer Boilerplate Generator
#
# Creates the folder structure and template files for a new layer implementation.
#
# Usage:
#   ./setup-layer --type network --name cloudflare
#   ./setup-layer --type distribution --name netlify
#   ./setup-layer --type provider --name digitalocean
#
# This will create:
#   frontend/deployment/{type}/{name}/
#   â”œâ”€â”€ setup
#   â””â”€â”€ modules/
#       â”œâ”€â”€ main.tf
#       â”œâ”€â”€ variables.tf
#       â”œâ”€â”€ locals.tf
#       â”œâ”€â”€ outputs.tf
#       â””â”€â”€ test_locals.tf
# =============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Script location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEPLOYMENT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Parse arguments
LAYER_TYPE=""
LAYER_NAME=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --type|-t)
      LAYER_TYPE="$2"
      shift 2
      ;;
    --name|-n)
      LAYER_NAME="$2"
      shift 2
      ;;
    --help|-h)
      echo "Usage: $0 --type <provider|network|distribution> --name <implementation_name>"
      echo ""
      echo "Examples:"
      echo "  $0 --type network --name cloudflare"
      echo "  $0 --type distribution --name netlify"
      echo "  $0 --type provider --name digitalocean"
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
  esac
done

# Validate arguments
if [[ -z "$LAYER_TYPE" ]]; then
  echo -e "${RED}Error: --type is required${NC}"
  echo "Valid types: provider, network, distribution"
  exit 1
fi

if [[ -z "$LAYER_NAME" ]]; then
  echo -e "${RED}Error: --name is required${NC}"
  exit 1
fi

if [[ ! "$LAYER_TYPE" =~ ^(provider|network|distribution)$ ]]; then
  echo -e "${RED}Error: Invalid layer type '$LAYER_TYPE'${NC}"
  echo "Valid types: provider, network, distribution"
  exit 1
fi

# Sanitize name (lowercase, replace spaces with underscores)
LAYER_NAME=$(echo "$LAYER_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr '-' '_')

# Target directory
TARGET_DIR="$DEPLOYMENT_DIR/$LAYER_TYPE/$LAYER_NAME"

if [[ -d "$TARGET_DIR" ]]; then
  echo -e "${RED}Error: Directory already exists: $TARGET_DIR${NC}"
  exit 1
fi

echo ""
echo -e "${CYAN}Creating $LAYER_TYPE layer: $LAYER_NAME${NC}"
echo ""

# Create directory structure
mkdir -p "$TARGET_DIR/modules"

# Determine variable prefix based on layer type
case $LAYER_TYPE in
  provider)
    VAR_PREFIX="${LAYER_NAME}_provider"
    ;;
  network)
    VAR_PREFIX="network"
    ;;
  distribution)
    VAR_PREFIX="distribution"
    ;;
esac

# =============================================================================
# Generate setup script
# =============================================================================

cat > "$TARGET_DIR/setup" << 'SETUP_HEADER'
#!/bin/bash
# =============================================================================
SETUP_HEADER

# Capitalize first letter of layer type and name
LAYER_TYPE_CAP="$(echo "${LAYER_TYPE:0:1}" | tr '[:lower:]' '[:upper:]')${LAYER_TYPE:1}"
LAYER_NAME_CAP="$(echo "${LAYER_NAME:0:1}" | tr '[:lower:]' '[:upper:]')${LAYER_NAME:1}"

cat >> "$TARGET_DIR/setup" << SETUP_META
# ${LAYER_TYPE_CAP}: ${LAYER_NAME}
#
# TODO: Add description of what this layer does.
#
# Required environment variables:
#   - TODO: List required env vars
#
# Required context values:
#   - TODO: List required context paths
# =============================================================================

set -euo pipefail

SETUP_META

cat >> "$TARGET_DIR/setup" << 'SETUP_BODY'
echo "ðŸ” Validating configuration..."
echo ""

# =============================================================================
# Input Validation
# =============================================================================

# TODO: Add validation for required environment variables
# Example:
# if [ -z "${REQUIRED_VAR:-}" ]; then
#   echo "   âŒ REQUIRED_VAR is missing"
#   echo ""
#   echo "  ðŸ’¡ Possible causes:"
#   echo "    â€¢ Variable not set in environment"
#   echo ""
#   echo "  ðŸ”§ How to fix:"
#   echo "    â€¢ export REQUIRED_VAR=value"
#   exit 1
# fi
# echo "   âœ… REQUIRED_VAR=$REQUIRED_VAR"

# TODO: Add validation for context values
# Example:
# config_value=$(echo "$CONTEXT" | jq -r '.path.to.value // empty')
# if [ -z "$config_value" ]; then
#   echo "   âŒ config_value not found in context"
#   exit 1
# fi
# echo "   âœ… config_value=$config_value"

# =============================================================================
# External Data Fetching (if needed)
# =============================================================================

# TODO: Add API calls to fetch external data
# Example:
# echo ""
# echo "   ðŸ“¡ Fetching resource..."
# api_response=$(curl -s "https://api.example.com/resource")
# if [ $? -ne 0 ]; then
#   echo "   âŒ Failed to fetch resource"
#   exit 1
# fi

# =============================================================================
# Update TOFU_VARIABLES
# =============================================================================

# TODO: Add layer-specific variables to TOFU_VARIABLES
# Use the appropriate prefix for your layer type:
#   - provider: {cloud}_provider object + provider_* vars
#   - network: network_* vars
#   - distribution: distribution_* vars
#
# Example:
# TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
#   --arg var1 "$value1" \
#   --arg var2 "$value2" \
#   '. + {
#     layer_variable1: $var1,
#     layer_variable2: $var2
#   }')

# =============================================================================
# Register Module
# =============================================================================

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n ${MODULES_TO_USE:-} ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi

echo ""
echo "âœ¨ Configuration completed successfully"
echo ""
SETUP_BODY

chmod +x "$TARGET_DIR/setup"
echo -e "  ${GREEN}âœ“${NC} Created setup script"

# =============================================================================
# Generate main.tf
# =============================================================================

cat > "$TARGET_DIR/modules/main.tf" << MAIN_TF
# =============================================================================
# ${LAYER_TYPE_CAP}: ${LAYER_NAME}
#
# TODO: Add description of resources managed by this module.
# =============================================================================

# TODO: Add terraform resources
#
# Example for network layer:
# resource "cloudflare_record" "main" {
#   zone_id = data.cloudflare_zone.main.id
#   name    = var.network_subdomain
#   value   = local.distribution_target_domain
#   type    = local.distribution_record_type
#   ttl     = 300
#   proxied = true
# }
#
# Example for distribution layer:
# resource "netlify_site" "main" {
#   name          = var.distribution_app_name
#   custom_domain = local.network_full_domain
# }
MAIN_TF

echo -e "  ${GREEN}âœ“${NC} Created modules/main.tf"

# =============================================================================
# Generate variables.tf
# =============================================================================

case $LAYER_TYPE in
  provider)
    cat > "$TARGET_DIR/modules/variables.tf" << VARIABLES_TF
# =============================================================================
# Provider Layer Variables
# =============================================================================

variable "${LAYER_NAME}_provider" {
  description = "${LAYER_NAME_CAP} provider configuration"
  type = object({
    # TODO: Define provider-specific fields
    # Example:
    # api_token = string
    # account_id = string
  })
}

variable "provider_resource_tags_json" {
  description = "Resource tags to apply to all resources"
  type        = map(string)
  default     = {}
}
VARIABLES_TF
    ;;

  network)
    cat > "$TARGET_DIR/modules/variables.tf" << 'VARIABLES_TF'
# =============================================================================
# Network Layer Variables
#
# NOTE: Use consistent naming with other network implementations:
#   - network_domain: Base domain (e.g., "example.com")
#   - network_subdomain: Subdomain part (e.g., "app")
#   - network_dns_zone_name: DNS zone identifier
# =============================================================================

variable "network_domain" {
  description = "Base domain name (e.g., example.com)"
  type        = string
}

variable "network_subdomain" {
  description = "Subdomain for the application (e.g., app)"
  type        = string
}

variable "network_dns_zone_name" {
  description = "DNS zone name/identifier"
  type        = string
}

# TODO: Add provider-specific variables with network_ prefix
# Example:
# variable "network_zone_id" {
#   description = "Cloudflare zone ID"
#   type        = string
# }
VARIABLES_TF
    ;;

  distribution)
    cat > "$TARGET_DIR/modules/variables.tf" << 'VARIABLES_TF'
# =============================================================================
# Distribution Layer Variables
#
# NOTE: Use consistent naming with other distribution implementations:
#   - distribution_app_name: Application/site name
#   - distribution_storage_account / distribution_bucket: Asset storage
#   - distribution_container / distribution_prefix: Asset path
# =============================================================================

variable "distribution_app_name" {
  description = "Application name for the CDN/hosting"
  type        = string
}

# TODO: Add provider-specific variables with distribution_ prefix
# Example for storage-backed CDN:
# variable "distribution_bucket" {
#   description = "S3/GCS bucket name for assets"
#   type        = string
# }
#
# variable "distribution_prefix" {
#   description = "Path prefix within the bucket"
#   type        = string
#   default     = ""
# }
VARIABLES_TF
    ;;
esac

echo -e "  ${GREEN}âœ“${NC} Created modules/variables.tf"

# =============================================================================
# Generate locals.tf
# =============================================================================

case $LAYER_TYPE in
  provider)
    cat > "$TARGET_DIR/modules/locals.tf" << 'LOCALS_TF'
# =============================================================================
# Provider Layer Locals
# =============================================================================

locals {
  # Provider layers typically don't need many locals
  # Add any computed values here
}
LOCALS_TF
    ;;

  network)
    cat > "$TARGET_DIR/modules/locals.tf" << 'LOCALS_TF'
# =============================================================================
# Network Layer Locals
#
# These locals are used by the distribution layer for cross-module integration.
# =============================================================================

locals {
  # Computed full domain - REQUIRED for distribution layer
  network_full_domain = "${var.network_subdomain}.${var.network_domain}"

  # Expose base domain for cross-module use
  network_domain = var.network_domain
}
LOCALS_TF
    ;;

  distribution)
    cat > "$TARGET_DIR/modules/locals.tf" << 'LOCALS_TF'
# =============================================================================
# Distribution Layer Locals
#
# Cross-layer integration with network layer.
# =============================================================================

locals {
  # Check if custom domain is configured (from network layer)
  distribution_has_custom_domain = local.network_full_domain != ""

  # Full domain from network layer
  distribution_full_domain = local.network_full_domain

  # TODO: Set these based on your CDN/hosting provider
  # These are consumed by the network layer for DNS record creation
  #
  # distribution_target_domain: The CDN endpoint hostname (e.g., "d123.cloudfront.net")
  # distribution_record_type: DNS record type ("CNAME" or "A" for alias)
  #
  # Example:
  # distribution_target_domain = netlify_site.main.ssl_url
  # distribution_record_type   = "CNAME"
}
LOCALS_TF
    ;;
esac

echo -e "  ${GREEN}âœ“${NC} Created modules/locals.tf"

# =============================================================================
# Generate outputs.tf
# =============================================================================

case $LAYER_TYPE in
  provider)
    cat > "$TARGET_DIR/modules/outputs.tf" << 'OUTPUTS_TF'
# =============================================================================
# Provider Layer Outputs
# =============================================================================

# Provider layers typically don't have outputs
# The provider configuration is used implicitly by other resources
OUTPUTS_TF
    ;;

  network)
    cat > "$TARGET_DIR/modules/outputs.tf" << 'OUTPUTS_TF'
# =============================================================================
# Network Layer Outputs
# =============================================================================

output "network_full_domain" {
  description = "Full domain name (subdomain.domain)"
  value       = local.network_full_domain
}

output "network_website_url" {
  description = "Full website URL with protocol"
  value       = "https://${local.network_full_domain}"
}

# TODO: Add provider-specific outputs
# Example:
# output "network_fqdn" {
#   description = "Fully qualified domain name with trailing dot"
#   value       = "${local.network_full_domain}."
# }
OUTPUTS_TF
    ;;

  distribution)
    cat > "$TARGET_DIR/modules/outputs.tf" << 'OUTPUTS_TF'
# =============================================================================
# Distribution Layer Outputs
# =============================================================================

output "distribution_cdn_endpoint_hostname" {
  description = "CDN endpoint hostname"
  value       = local.distribution_target_domain
}

output "distribution_website_url" {
  description = "Website URL (custom domain if configured, otherwise CDN URL)"
  value       = local.distribution_has_custom_domain ? "https://${local.distribution_full_domain}" : "https://${local.distribution_target_domain}"
}

# TODO: Add provider-specific outputs
# Example:
# output "distribution_site_id" {
#   description = "Netlify site ID"
#   value       = netlify_site.main.id
# }
OUTPUTS_TF
    ;;
esac

echo -e "  ${GREEN}âœ“${NC} Created modules/outputs.tf"

# =============================================================================
# Generate test_locals.tf
# =============================================================================

case $LAYER_TYPE in
  provider)
    cat > "$TARGET_DIR/modules/test_locals.tf" << 'TEST_LOCALS_TF'
# =============================================================================
# Test-Only Locals
#
# NOTE: Files matching test_*.tf are skipped by compose_modules.
# This file provides stubs for unit testing in isolation.
# =============================================================================

# Provider layers typically don't need test locals
TEST_LOCALS_TF
    ;;

  network)
    cat > "$TARGET_DIR/modules/test_locals.tf" << 'TEST_LOCALS_TF'
# =============================================================================
# Test-Only Locals
#
# NOTE: Files matching test_*.tf are skipped by compose_modules.
# This file provides stubs for unit testing in isolation.
# =============================================================================

# Network layer needs distribution layer outputs for DNS records
variable "distribution_target_domain" {
  description = "Test-only: CDN endpoint hostname from distribution layer"
  type        = string
  default     = "test-cdn.example.net"
}

variable "distribution_record_type" {
  description = "Test-only: DNS record type from distribution layer"
  type        = string
  default     = "CNAME"
}

locals {
  distribution_target_domain = var.distribution_target_domain
  distribution_record_type   = var.distribution_record_type
}
TEST_LOCALS_TF
    ;;

  distribution)
    cat > "$TARGET_DIR/modules/test_locals.tf" << 'TEST_LOCALS_TF'
# =============================================================================
# Test-Only Locals
#
# NOTE: Files matching test_*.tf are skipped by compose_modules.
# This file provides stubs for unit testing in isolation.
# =============================================================================

# Distribution layer needs network layer outputs for custom domain
variable "network_full_domain" {
  description = "Test-only: Full domain from network layer"
  type        = string
  default     = ""
}

variable "network_domain" {
  description = "Test-only: Base domain from network layer"
  type        = string
  default     = "example.com"
}

locals {
  network_full_domain = var.network_full_domain
  network_domain      = var.network_domain
}
TEST_LOCALS_TF
    ;;
esac

echo -e "  ${GREEN}âœ“${NC} Created modules/test_locals.tf"

# =============================================================================
# Create test directory structure
# =============================================================================

TEST_DIR="$DEPLOYMENT_DIR/tests/$LAYER_TYPE/$LAYER_NAME"
mkdir -p "$TEST_DIR"

cat > "$TEST_DIR/${LAYER_NAME}.tftest.hcl" << TEST_HCL
# =============================================================================
# Unit Tests: ${LAYER_TYPE}/${LAYER_NAME}
# =============================================================================

mock_provider "${LAYER_NAME}" {}

# =============================================================================
# Test Variables
# =============================================================================

variables {
  # TODO: Add test variable values
}

# =============================================================================
# Tests
# =============================================================================

run "test_basic_configuration" {
  command = plan

  # TODO: Add assertions
  # assert {
  #   condition     = resource.type.name != null
  #   error_message = "Resource should be created"
  # }
}
TEST_HCL

echo -e "  ${GREEN}âœ“${NC} Created tests/$LAYER_TYPE/$LAYER_NAME/${LAYER_NAME}.tftest.hcl"

# =============================================================================
# Summary
# =============================================================================

echo ""
echo -e "${GREEN}Layer created successfully!${NC}"
echo ""
echo "Created structure:"
echo "  $TARGET_DIR/"
echo "  â”œâ”€â”€ setup"
echo "  â””â”€â”€ modules/"
echo "      â”œâ”€â”€ main.tf"
echo "      â”œâ”€â”€ variables.tf"
echo "      â”œâ”€â”€ locals.tf"
echo "      â”œâ”€â”€ outputs.tf"
echo "      â””â”€â”€ test_locals.tf"
echo ""
echo "  $TEST_DIR/"
echo "  â””â”€â”€ ${LAYER_NAME}.tftest.hcl"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  1. Edit the setup script to add validation and TOFU_VARIABLES"
echo "  2. Edit modules/main.tf to add Terraform resources"
echo "  3. Update modules/variables.tf with required inputs"
echo "  4. Update modules/locals.tf with cross-layer references"
echo "  5. Add unit tests to tests/$LAYER_TYPE/$LAYER_NAME/"
echo ""
echo -e "${CYAN}Tip:${NC} See frontend/README.md for the Claude prompt template"
echo "     to help implement the setup script and Terraform files."
echo ""
