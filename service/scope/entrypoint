#!/bin/bash

echo "Executing scope action=$SERVICE_ACTION, type=$SERVICE_ACTION_TYPE for scope=$SCOPE_ID"

map_custom_action() {
  local action="$1"
  
  case "$action" in
    "delete-scope")
      echo "delete"
      ;;
    "status-scope")
      echo "status"
      ;;
    *)
      echo "$action"
      ;;
  esac
}


ACTION_TO_EXECUTE=""

case "$SERVICE_ACTION_TYPE" in
  "custom")
      ACTION_TO_EXECUTE=$(map_custom_action "$SERVICE_ACTION")
    ;;
  *)
    ACTION_TO_EXECUTE="$SERVICE_ACTION_TYPE"
    ;;
esac

WORKFLOW_PATH="$SERVICE_PATH/scope/workflows/$ACTION_TO_EXECUTE.yaml"

if [[ ! -f "$WORKFLOW_PATH" ]]; then
  WORKFLOW_PATH="$OVERRIDES_PATH/scope/workflows/$ACTION_TO_EXECUTE.yaml"
else
  OVERRIDES_WORKFLOW_PATH="$OVERRIDES_PATH/scope/workflows/$ACTION_TO_EXECUTE.yaml"
fi

CMD="np service workflow exec --workflow $WORKFLOW_PATH --build-context --include-secrets"

if [[ -f "$OVERRIDES_WORKFLOW_PATH" ]]; then
  CMD="$CMD --overrides $OVERRIDES_WORKFLOW_PATH"
fi

echo "Executing command: $CMD"
eval $CMD

