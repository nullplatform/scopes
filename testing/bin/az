#!/bin/bash
# =============================================================================
# Mock Azure CLI for Integration Testing
#
# This script emulates the Azure CLI by querying the Azure Mock server.
# Only implements the commands needed for integration testing.
#
# Supported commands:
#   az network dns zone show --name <zone> --resource-group <rg>
#   az network dns record-set cname show --name <name> --zone-name <zone> --resource-group <rg>
#   az cdn profile show --name <profile> --resource-group <rg>
#   az cdn endpoint show --name <endpoint> --profile-name <profile> --resource-group <rg>
#   az storage account show --name <account> --resource-group <rg>
# =============================================================================

AZURE_MOCK_ENDPOINT="${AZURE_MOCK_ENDPOINT:-http://localhost:8090}"
ARM_SUBSCRIPTION_ID="${ARM_SUBSCRIPTION_ID:-mock-subscription-id}"

# Parse command structure
cmd="$1"
subcmd="$2"
action="$3"

case "$cmd" in
  network)
    case "$subcmd" in
      dns)
        case "$action" in
          zone)
            shift 3
            subaction="$1"
            case "$subaction" in
              show)
                shift
                # Parse arguments
                while [[ $# -gt 0 ]]; do
                  case $1 in
                    --name|-n) zone_name="$2"; shift 2 ;;
                    --resource-group|-g) resource_group="$2"; shift 2 ;;
                    *) shift ;;
                  esac
                done

                if [[ -z "$zone_name" || -z "$resource_group" ]]; then
                  echo "ERROR: --name and --resource-group are required" >&2
                  exit 1
                fi

                # Query Azure Mock
                response=$(curl -s "${AZURE_MOCK_ENDPOINT}/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${resource_group}/providers/Microsoft.Network/dnszones/${zone_name}")

                # Check for error
                error_code=$(echo "$response" | jq -r '.error.code // empty')
                if [[ -n "$error_code" ]]; then
                  echo "ERROR: ResourceNotFound - The DNS zone '${zone_name}' was not found." >&2
                  exit 1
                fi

                echo "$response"
                ;;
              *)
                echo "ERROR: Unknown subaction: $subaction" >&2
                exit 1
                ;;
            esac
            ;;
          record-set)
            shift 3
            record_type="$1"
            subaction="$2"
            case "$record_type" in
              cname)
                case "$subaction" in
                  show)
                    shift 2
                    # Parse arguments
                    while [[ $# -gt 0 ]]; do
                      case $1 in
                        --name|-n) record_name="$2"; shift 2 ;;
                        --zone-name|-z) zone_name="$2"; shift 2 ;;
                        --resource-group|-g) resource_group="$2"; shift 2 ;;
                        *) shift ;;
                      esac
                    done

                    if [[ -z "$record_name" || -z "$zone_name" || -z "$resource_group" ]]; then
                      echo "ERROR: --name, --zone-name, and --resource-group are required" >&2
                      exit 1
                    fi

                    # Query Azure Mock
                    response=$(curl -s "${AZURE_MOCK_ENDPOINT}/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${resource_group}/providers/Microsoft.Network/dnszones/${zone_name}/CNAME/${record_name}")

                    # Check for error
                    error_code=$(echo "$response" | jq -r '.error.code // empty')
                    if [[ -n "$error_code" ]]; then
                      echo "ERROR: ResourceNotFound - The CNAME record '${record_name}' was not found." >&2
                      exit 1
                    fi

                    echo "$response"
                    ;;
                  *)
                    echo "ERROR: Unknown subaction: $subaction" >&2
                    exit 1
                    ;;
                esac
                ;;
              *)
                echo "ERROR: Unknown record type: $record_type" >&2
                exit 1
                ;;
            esac
            ;;
          *)
            echo "ERROR: Unknown dns action: $action" >&2
            exit 1
            ;;
        esac
        ;;
      *)
        echo "ERROR: Unknown network subcommand: $subcmd" >&2
        exit 1
        ;;
    esac
    ;;

  cdn)
    case "$subcmd" in
      profile)
        case "$action" in
          show)
            shift 3
            # Parse arguments
            while [[ $# -gt 0 ]]; do
              case $1 in
                --name|-n) profile_name="$2"; shift 2 ;;
                --resource-group|-g) resource_group="$2"; shift 2 ;;
                *) shift ;;
              esac
            done

            if [[ -z "$profile_name" || -z "$resource_group" ]]; then
              echo "ERROR: --name and --resource-group are required" >&2
              exit 1
            fi

            # Query Azure Mock
            response=$(curl -s "${AZURE_MOCK_ENDPOINT}/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${resource_group}/providers/Microsoft.Cdn/profiles/${profile_name}")

            # Check for error
            error_code=$(echo "$response" | jq -r '.error.code // empty')
            if [[ -n "$error_code" ]]; then
              echo "ERROR: ResourceNotFound - The CDN profile '${profile_name}' was not found." >&2
              exit 1
            fi

            echo "$response"
            ;;
          *)
            echo "ERROR: Unknown cdn profile action: $action" >&2
            exit 1
            ;;
        esac
        ;;
      endpoint)
        case "$action" in
          show)
            shift 3
            # Parse arguments
            while [[ $# -gt 0 ]]; do
              case $1 in
                --name|-n) endpoint_name="$2"; shift 2 ;;
                --profile-name) profile_name="$2"; shift 2 ;;
                --resource-group|-g) resource_group="$2"; shift 2 ;;
                *) shift ;;
              esac
            done

            if [[ -z "$endpoint_name" || -z "$profile_name" || -z "$resource_group" ]]; then
              echo "ERROR: --name, --profile-name, and --resource-group are required" >&2
              exit 1
            fi

            # Query Azure Mock
            response=$(curl -s "${AZURE_MOCK_ENDPOINT}/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${resource_group}/providers/Microsoft.Cdn/profiles/${profile_name}/endpoints/${endpoint_name}")

            # Check for error
            error_code=$(echo "$response" | jq -r '.error.code // empty')
            if [[ -n "$error_code" ]]; then
              echo "ERROR: ResourceNotFound - The CDN endpoint '${endpoint_name}' was not found." >&2
              exit 1
            fi

            echo "$response"
            ;;
          *)
            echo "ERROR: Unknown cdn endpoint action: $action" >&2
            exit 1
            ;;
        esac
        ;;
      *)
        echo "ERROR: Unknown cdn subcommand: $subcmd" >&2
        exit 1
        ;;
    esac
    ;;

  storage)
    case "$subcmd" in
      account)
        case "$action" in
          show)
            shift 3
            # Parse arguments
            while [[ $# -gt 0 ]]; do
              case $1 in
                --name|-n) account_name="$2"; shift 2 ;;
                --resource-group|-g) resource_group="$2"; shift 2 ;;
                *) shift ;;
              esac
            done

            if [[ -z "$account_name" || -z "$resource_group" ]]; then
              echo "ERROR: --name and --resource-group are required" >&2
              exit 1
            fi

            # Query Azure Mock
            response=$(curl -s "${AZURE_MOCK_ENDPOINT}/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${resource_group}/providers/Microsoft.Storage/storageAccounts/${account_name}")

            # Check for error
            error_code=$(echo "$response" | jq -r '.error.code // empty')
            if [[ -n "$error_code" ]]; then
              echo "ERROR: ResourceNotFound - The storage account '${account_name}' was not found." >&2
              exit 1
            fi

            echo "$response"
            ;;
          *)
            echo "ERROR: Unknown storage account action: $action" >&2
            exit 1
            ;;
        esac
        ;;
      *)
        echo "ERROR: Unknown storage subcommand: $subcmd" >&2
        exit 1
        ;;
    esac
    ;;

  version)
    echo '{"azure-cli": "2.99.0-mock", "azure-cli-core": "2.99.0-mock"}'
    ;;

  *)
    echo "ERROR: Unknown command: $cmd" >&2
    echo "This is a mock Azure CLI for integration testing." >&2
    echo "Supported commands: network dns zone, cdn profile/endpoint, storage account" >&2
    exit 1
    ;;
esac
