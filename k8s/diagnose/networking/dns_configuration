#!/bin/bash

print_info "ðŸ”Ž DNS Configuration:"
dns_policy=$(kubectl get pod "$pod_name" -n "$K8S_NAMESPACE" -o jsonpath='{.spec.dnsPolicy}' 2>/dev/null)
echo "  DNS Policy: ${dns_policy:-Default}"

DNS_TEST_RESULT="unknown"
if [ "$pod_phase" == "Running" ]; then
    first_container=$(kubectl get pod "$pod_name" -n "$K8S_NAMESPACE" -o jsonpath='{.spec.containers[0].name}' 2>/dev/null)

    print_info "  DNS Resolution Test:"
    if kubectl exec "$pod_name" -n "$K8S_NAMESPACE" -c "$first_container" -- nslookup kubernetes.default.svc.cluster.local &>/dev/null; then
        print_success "    âœ“ DNS resolution working"
        DNS_TEST_RESULT="passed"
    else
        print_warning "    DNS resolution failed or nslookup not available"
        DNS_TEST_RESULT="failed"
    fi
fi

pod_network_data=$(jq -nc \
    --arg dns_policy "$dns_policy" \
    --arg dns_test "$DNS_TEST_RESULT" \
    '{dnsPolicy: $dns_policy, dnsTest: $dns_test}')

update_check_result --status "SUCCESS" \
                    --evidence "$pod_network_data" \
                    --output-file "$SCRIPT_OUTPUT_FILE"
