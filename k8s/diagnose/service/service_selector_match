#!/bin/bash
# Check: Service Selector Match
# Validates service selectors match pod labels

# Validate services exist
require_services || return 0

# Read services from pre-collected data
SERVICES=$(jq -r '.items[].metadata.name' "$SERVICES_FILE" 2>/dev/null | tr '\n' ' ')

HAS_MISMATCH=0

for SERVICE_NAME in $SERVICES; do
    # Get service info from pre-collected data
    SERVICE_INFO=$(jq --arg name "$SERVICE_NAME" '.items[] | select(.metadata.name == $name)' "$SERVICES_FILE" 2>/dev/null)

    # Get service selectors
    SERVICE_SELECTORS=$(echo "$SERVICE_INFO" | jq -r '.spec.selector | to_entries | map("\(.key)=\(.value)") | join(",")')

    if [[ -z "$SERVICE_SELECTORS" || "$SERVICE_SELECTORS" == "null" ]]; then
        HAS_MISMATCH=1
        print_error "Service $SERVICE_NAME: No selector defined"
        continue
    fi

    # Find pods that match service selector from pre-collected data
    # Get service selector as a proper object
    SELECTOR_OBJECT=$(echo "$SERVICE_INFO" | jq -c '.spec.selector')

    # Match pods where all service selectors are present in pod labels
    MATCHING_PODS=$(jq -r --argjson selectors "$SELECTOR_OBJECT" '
      .items[] |
      . as $pod |
      select(
        $selectors | to_entries | all(.key as $k | .value as $v |
          $pod.metadata.labels[$k] == $v
        )
      ) |
      .metadata.name
    ' "$PODS_FILE" 2>/dev/null | tr '\n' ' ')

    if [[ -z "$MATCHING_PODS" ]]; then
        HAS_MISMATCH=1
        print_error "Service $SERVICE_NAME: No pods match selector ($SERVICE_SELECTORS)"

        # Show what pods exist with deployment_id from pre-collected data
        EXISTING_PODS=$(jq -r --arg dep_id "$DEPLOYMENT_ID" '.items[] | select(.metadata.labels.deployment_id == $dep_id) | .metadata.name' "$PODS_FILE" 2>/dev/null | tr '\n' ' ')
        if [[ -n "$EXISTING_PODS" ]]; then
            print_warning "  Existing pods with deployment_id: $EXISTING_PODS"

            # Show first pod's labels for comparison
            FIRST_POD=$(echo "$EXISTING_PODS" | awk '{print $1}')
            POD_LABELS=$(jq -r --arg pod "$FIRST_POD" '.items[] | select(.metadata.name == $pod) | .metadata.labels | to_entries | map("\(.key)=\(.value)") | join(",")' "$PODS_FILE" 2>/dev/null)
            print_info "  Pod labels: $POD_LABELS"

            # Check each selector against pod labels and show only mismatches
            MISMATCHES=""
            MATCH_COUNT=0
            SELECTOR_COUNT=0
            while IFS='=' read -r key value; do
                SELECTOR_COUNT=$((SELECTOR_COUNT + 1))
                POD_VALUE=$(jq -r --arg pod "$FIRST_POD" --arg key "$key" '.items[] | select(.metadata.name == $pod) | .metadata.labels[$key] // "MISSING"' "$PODS_FILE" 2>/dev/null)
                if [[ "$POD_VALUE" == "MISSING" ]]; then
                    MISMATCHES="${MISMATCHES}    ✗ $key: selector='$value', pod=MISSING\n"
                elif [[ "$POD_VALUE" != "$value" ]]; then
                    MISMATCHES="${MISMATCHES}    ✗ $key: selector='$value', pod='$POD_VALUE'\n"
                else
                    MATCH_COUNT=$((MATCH_COUNT + 1))
                fi
            done < <(echo "$SELECTOR_OBJECT" | jq -r 'to_entries[] | "\(.key)=\(.value)"')

            print_info "  Selector check: $MATCH_COUNT/$SELECTOR_COUNT labels match"

            if [[ -n "$MISMATCHES" ]]; then
                print_warning "  Selector mismatches:"
                echo -e "$MISMATCHES"
            else
                print_warning "  All selectors match but jq query failed - checking jq logic..."
                # Debug: try the query manually to see what happens
                DEBUG_RESULT=$(jq --argjson selectors "$SELECTOR_OBJECT" --arg pod "$FIRST_POD" '
                  .items[] | select(.metadata.name == $pod) |
                  . as $p |
                  {
                    pod: .metadata.name,
                    matches: ($selectors | to_entries | all(.key as $k | .value as $v |
                      $p.metadata.labels[$k] == $v
                    ))
                  }
                ' "$PODS_FILE" 2>&1)
                print_info "  Debug result: $DEBUG_RESULT"
            fi

            print_info "  Action: Verify pod labels match service selector"
        fi
    else
        POD_COUNT=$(echo "$MATCHING_PODS" | wc -w)
        print_success "Service $SERVICE_NAME: Selector matches $POD_COUNT pod(s)"
    fi
done

if [[ $HAS_MISMATCH -eq 0 ]]; then
    update_check_result --status "success" --evidence "{}"
else
    update_check_result --status "failed" --evidence "{}"
fi