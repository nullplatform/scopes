#!/bin/bash
# Check: Service Existence
# Verifies that service resources exist in the namespace

LABEL_SELECTOR="deployment_id=$DEPLOYMENT_ID,scope_id=$SCOPE_ID"

# Get services matching labels
SERVICES=$(kubectl get services -n "$NAMESPACE" -l "$LABEL_SELECTOR" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)

if [[ -z "$SERVICES" ]]; then
    print_error "No services found with $LABEL_SELECTOR"

    # Check if there are services with just deployment_id
    SERVICES_BY_DEPLOYMENT=$(kubectl get services -n "$NAMESPACE" -l "deployment_id=$DEPLOYMENT_ID" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)

    if [[ -n "$SERVICES_BY_DEPLOYMENT" ]]; then
        print_warning "Found services with deployment_id but different scope_id: $SERVICES_BY_DEPLOYMENT"
    fi

    update_check_result --status "failed" --evidence "{}"
fi

SERVICE_COUNT=$(echo "$SERVICES" | wc -w)
print_success "Found $SERVICE_COUNT service(s): $SERVICES"
update_check_result --status "success" --evidence "{}"
