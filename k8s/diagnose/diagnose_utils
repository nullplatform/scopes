#!/bin/bash

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

update_check_result() {
    # Usage:
    #   update_check_result output.json "new-status" '{"new":"evidence"}'
    # or:
    #   update_check_result --output-file output.json --status "new-status" --evidence '{"new":"evidence"}'

    # Argument parsing
    if [[ "$1" == --* ]]; then
        while [[ $# -gt 0 ]]; do
            case $1 in
                --status) status="$2"; shift 2 ;;
                --evidence) evidence="$2"; shift 2 ;;
                --file|--output-file) output_file="$2"; shift 2 ;;
                *) echo "Unknown parameter: $1" >&2; return 1 ;;
            esac
        done
    else
        output_file="$1"
        status="$2"
        evidence="$3"
    fi

    # Basic validation
    if [[ -z "$output_file" || -z "$status" || -z "$evidence" ]]; then
        echo "Error: output_file, status and evidence are required" >&2
        return 1
    fi

    if [[ $output_file != *.json ]]; then
      output_file="$output_file.json"
    fi

    if [[ ! -f "$output_file" ]]; then
        echo "Error: File not found: $output_file" >&2
        return 1
    fi

    # Safely update JSON (write to tmp then move)
    tmpfile="$(mktemp)"
    if ! jq \
        --arg status "$status" \
        --argjson evidence "$evidence" \
        '.status = ($status | ascii_downcase) | .evidence = $evidence' \
        "$output_file" > "$tmpfile"; then
        echo "Error: Failed to update JSON (is evidence valid JSON?)" >&2
        rm -f "$tmpfile"
        return 1
    fi

    mv "$tmpfile" "$output_file"
}

notify_results() {
    # Find all JSON result files
    local json_files
    json_files=$(find "$NP_OUTPUT_DIR" -type f -name "*.json")

    if [[ -z "$json_files" ]]; then
        print_warning "No JSON result files found in $NP_OUTPUT_DIR"
        exit 1
    fi

    local output_file="$NP_OUTPUT_DIR/grouped_results.json"

    jq -s '
      # category helper
      def cat: .category // "unknown";

      # we get an array of all check objects
      sort_by(cat)
      | group_by(cat)
      | map({
          category: (.[0].category // "unknown"),
          checkSummary: {
            pending: (map(select((.status // "UNKNOWN") == "pending")) | length),
            running: (map(select((.status // "UNKNOWN") == "running")) | length),
            success: (map(select((.status // "UNKNOWN") == "success")) | length),
            failed:  (map(select((.status // "UNKNOWN") == "failed"))  | length)
          },
          checks: .
        })
    ' $json_files > "$output_file"

      jq -c '.' "$output_file"
}