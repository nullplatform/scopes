#!/bin/bash
# Check: Health Probe Endpoints
# Validates that liveness and readiness probe endpoints are configured and responding correctly

# Validate pods exist
require_pods || return 0

# Read pods from pre-collected data
PODS=$(jq -r '.items[].metadata.name' "$PODS_FILE" 2>/dev/null | tr '\n' ' ')

HAS_PROBE_ISSUES=0

for POD_NAME in $PODS; do
    # Get pod info from pre-collected data
    POD_INFO=$(jq --arg name "$POD_NAME" '.items[] | select(.metadata.name == $name)' "$PODS_FILE" 2>/dev/null)

    # Check if pod is running
    POD_PHASE=$(echo "$POD_INFO" | jq -r '.status.phase')
    if [[ "$POD_PHASE" != "Running" ]]; then
        print_warning "Pod $POD_NAME: Not running (phase: $POD_PHASE), skipping probe checks"
        continue
    fi

    print_info "Checking pod $POD_NAME:"

    # Get pod ready status
    POD_READY=$(echo "$POD_INFO" | jq -r '.status.conditions[] | select(.type=="Ready") | .status')

    # Get all containers
    CONTAINERS=$(echo "$POD_INFO" | jq -r '.spec.containers[] | @base64')

    for CONTAINER_B64 in $CONTAINERS; do
        CONTAINER_DATA=$(echo "$CONTAINER_B64" | base64 -d)
        CONTAINER_NAME=$(echo "$CONTAINER_DATA" | jq -r '.name')

        print_info "  Container '$CONTAINER_NAME':"

        # Check if container has any probes configured
        HAS_READINESS=$(echo "$CONTAINER_DATA" | jq -r '.readinessProbe // empty')
        HAS_LIVENESS=$(echo "$CONTAINER_DATA" | jq -r '.livenessProbe // empty')
        HAS_STARTUP=$(echo "$CONTAINER_DATA" | jq -r '.startupProbe // empty')

        if [[ -z "$HAS_READINESS" && -z "$HAS_LIVENESS" && -z "$HAS_STARTUP" ]]; then
            print_warning "    No health probes configured (recommend adding readiness/liveness probes)"
            continue
        fi

        # Check Readiness Probe
        if [[ -n "$HAS_READINESS" ]]; then
            PROBE_TYPE=$(echo "$CONTAINER_DATA" | jq -r 'if .readinessProbe.httpGet then "httpGet" elif .readinessProbe.tcpSocket then "tcpSocket" elif .readinessProbe.exec then "exec" else "unknown" end')

            if [[ "$PROBE_TYPE" == "httpGet" ]]; then
                PROBE_PATH=$(echo "$CONTAINER_DATA" | jq -r '.readinessProbe.httpGet.path')
                PROBE_PORT=$(echo "$CONTAINER_DATA" | jq -r '.readinessProbe.httpGet.port')
                PROBE_SCHEME=$(echo "$CONTAINER_DATA" | jq -r '.readinessProbe.httpGet.scheme // "HTTP"')
                PROBE_URL="$PROBE_SCHEME://localhost:$PROBE_PORT$PROBE_PATH"

                # Try curl first, then wget
                if kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "command -v curl >/dev/null 2>&1" 2>/dev/null; then
                    if [[ "$PROBE_SCHEME" == "HTTPS" ]]; then
                        PROBE_RESPONSE=$(kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "curl -k -s -o /dev/null -w '%{http_code}' --max-time 2 '$PROBE_URL'" 2>&1)
                    else
                        PROBE_RESPONSE=$(kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "curl -s -o /dev/null -w '%{http_code}' --max-time 2 '$PROBE_URL'" 2>&1)
                    fi
                    PROBE_EXIT_CODE=$?
                elif kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "command -v wget >/dev/null 2>&1" 2>/dev/null; then
                    if [[ "$PROBE_SCHEME" == "HTTPS" ]]; then
                        kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "wget --no-check-certificate -q -O /dev/null --timeout=2 '$PROBE_URL'" >/dev/null 2>&1
                    else
                        kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "wget -q -O /dev/null --timeout=2 '$PROBE_URL'" >/dev/null 2>&1
                    fi
                    PROBE_EXIT_CODE=$?
                    PROBE_RESPONSE=$([[ $PROBE_EXIT_CODE -eq 0 ]] && echo "200" || echo "failed")
                else
                    print_warning "    Readiness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: Cannot test (curl/wget not available)"
                    continue
                fi

                if [[ $PROBE_EXIT_CODE -eq 0 && "$PROBE_RESPONSE" =~ ^[2-3][0-9][0-9]$ ]]; then
                    print_success "    Readiness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ✓ HTTP $PROBE_RESPONSE"
                else
                    if [[ "$POD_READY" != "True" ]]; then
                        print_warning "    Readiness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ⚠ HTTP $PROBE_RESPONSE (pod not ready - likely the cause)"
                    else
                        HAS_PROBE_ISSUES=1
                        print_error "    Readiness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ✗ HTTP $PROBE_RESPONSE (check endpoint path/port)"
                    fi
                fi
            elif [[ "$PROBE_TYPE" == "tcpSocket" ]]; then
                PROBE_PORT=$(echo "$CONTAINER_DATA" | jq -r '.readinessProbe.tcpSocket.port')
                print_info "    Readiness Probe: TCP Socket on port $PROBE_PORT (tested in port health check)"
            elif [[ "$PROBE_TYPE" == "exec" ]]; then
                PROBE_COMMAND=$(echo "$CONTAINER_DATA" | jq -r '.readinessProbe.exec.command | join(" ")')
                print_info "    Readiness Probe: Exec [$PROBE_COMMAND] (cannot test directly)"
            fi
        fi

        # Check Liveness Probe
        if [[ -n "$HAS_LIVENESS" ]]; then
            PROBE_TYPE=$(echo "$CONTAINER_DATA" | jq -r 'if .livenessProbe.httpGet then "httpGet" elif .livenessProbe.tcpSocket then "tcpSocket" elif .livenessProbe.exec then "exec" else "unknown" end')

            if [[ "$PROBE_TYPE" == "httpGet" ]]; then
                PROBE_PATH=$(echo "$CONTAINER_DATA" | jq -r '.livenessProbe.httpGet.path')
                PROBE_PORT=$(echo "$CONTAINER_DATA" | jq -r '.livenessProbe.httpGet.port')
                PROBE_SCHEME=$(echo "$CONTAINER_DATA" | jq -r '.livenessProbe.httpGet.scheme // "HTTP"')
                PROBE_URL="$PROBE_SCHEME://localhost:$PROBE_PORT$PROBE_PATH"

                # Try curl first, then wget
                if kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "command -v curl >/dev/null 2>&1" 2>/dev/null; then
                    if [[ "$PROBE_SCHEME" == "HTTPS" ]]; then
                        PROBE_RESPONSE=$(kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "curl -k -s -o /dev/null -w '%{http_code}' --max-time 2 '$PROBE_URL'" 2>&1)
                    else
                        PROBE_RESPONSE=$(kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "curl -s -o /dev/null -w '%{http_code}' --max-time 2 '$PROBE_URL'" 2>&1)
                    fi
                    PROBE_EXIT_CODE=$?
                elif kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "command -v wget >/dev/null 2>&1" 2>/dev/null; then
                    if [[ "$PROBE_SCHEME" == "HTTPS" ]]; then
                        kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "wget --no-check-certificate -q -O /dev/null --timeout=2 '$PROBE_URL'" >/dev/null 2>&1
                    else
                        kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "wget -q -O /dev/null --timeout=2 '$PROBE_URL'" >/dev/null 2>&1
                    fi
                    PROBE_EXIT_CODE=$?
                    PROBE_RESPONSE=$([[ $PROBE_EXIT_CODE -eq 0 ]] && echo "200" || echo "failed")
                else
                    print_warning "    Liveness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: Cannot test (curl/wget not available)"
                    continue
                fi

                if [[ $PROBE_EXIT_CODE -eq 0 && "$PROBE_RESPONSE" =~ ^[2-3][0-9][0-9]$ ]]; then
                    print_success "    Liveness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ✓ HTTP $PROBE_RESPONSE"
                else
                    if [[ "$POD_READY" != "True" ]]; then
                        print_warning "    Liveness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ⚠ HTTP $PROBE_RESPONSE (may cause pod restart if continues)"
                    else
                        HAS_PROBE_ISSUES=1
                        print_error "    Liveness Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ✗ HTTP $PROBE_RESPONSE (check endpoint path/port)"
                    fi
                fi
            elif [[ "$PROBE_TYPE" == "tcpSocket" ]]; then
                PROBE_PORT=$(echo "$CONTAINER_DATA" | jq -r '.livenessProbe.tcpSocket.port')
                print_info "    Liveness Probe: TCP Socket on port $PROBE_PORT (tested in port health check)"
            elif [[ "$PROBE_TYPE" == "exec" ]]; then
                PROBE_COMMAND=$(echo "$CONTAINER_DATA" | jq -r '.livenessProbe.exec.command | join(" ")')
                print_info "    Liveness Probe: Exec [$PROBE_COMMAND] (cannot test directly)"
            fi
        fi

        # Check Startup Probe
        if [[ -n "$HAS_STARTUP" ]]; then
            PROBE_TYPE=$(echo "$CONTAINER_DATA" | jq -r 'if .startupProbe.httpGet then "httpGet" elif .startupProbe.tcpSocket then "tcpSocket" elif .startupProbe.exec then "exec" else "unknown" end')

            if [[ "$PROBE_TYPE" == "httpGet" ]]; then
                PROBE_PATH=$(echo "$CONTAINER_DATA" | jq -r '.startupProbe.httpGet.path')
                PROBE_PORT=$(echo "$CONTAINER_DATA" | jq -r '.startupProbe.httpGet.port')
                PROBE_SCHEME=$(echo "$CONTAINER_DATA" | jq -r '.startupProbe.httpGet.scheme // "HTTP"')
                PROBE_URL="$PROBE_SCHEME://localhost:$PROBE_PORT$PROBE_PATH"

                # Try curl first, then wget
                if kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "command -v curl >/dev/null 2>&1" 2>/dev/null; then
                    if [[ "$PROBE_SCHEME" == "HTTPS" ]]; then
                        PROBE_RESPONSE=$(kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "curl -k -s -o /dev/null -w '%{http_code}' --max-time 2 '$PROBE_URL'" 2>&1)
                    else
                        PROBE_RESPONSE=$(kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "curl -s -o /dev/null -w '%{http_code}' --max-time 2 '$PROBE_URL'" 2>&1)
                    fi
                    PROBE_EXIT_CODE=$?
                elif kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "command -v wget >/dev/null 2>&1" 2>/dev/null; then
                    if [[ "$PROBE_SCHEME" == "HTTPS" ]]; then
                        kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "wget --no-check-certificate -q -O /dev/null --timeout=2 '$PROBE_URL'" >/dev/null 2>&1
                    else
                        kubectl exec "$POD_NAME" -n "$NAMESPACE" -c "$CONTAINER_NAME" -- sh -c "wget -q -O /dev/null --timeout=2 '$PROBE_URL'" >/dev/null 2>&1
                    fi
                    PROBE_EXIT_CODE=$?
                    PROBE_RESPONSE=$([[ $PROBE_EXIT_CODE -eq 0 ]] && echo "200" || echo "failed")
                else
                    print_warning "    Startup Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: Cannot test (curl/wget not available)"
                    continue
                fi

                if [[ $PROBE_EXIT_CODE -eq 0 && "$PROBE_RESPONSE" =~ ^[2-3][0-9][0-9]$ ]]; then
                    print_success "    Startup Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ✓ HTTP $PROBE_RESPONSE"
                else
                    print_warning "    Startup Probe on $PROBE_SCHEME://$PROBE_PORT$PROBE_PATH: ⚠ HTTP $PROBE_RESPONSE (protects slow-starting containers)"
                fi
            elif [[ "$PROBE_TYPE" == "tcpSocket" ]]; then
                PROBE_PORT=$(echo "$CONTAINER_DATA" | jq -r '.startupProbe.tcpSocket.port')
                print_info "    Startup Probe: TCP Socket on port $PROBE_PORT"
            elif [[ "$PROBE_TYPE" == "exec" ]]; then
                PROBE_COMMAND=$(echo "$CONTAINER_DATA" | jq -r '.startupProbe.exec.command | join(" ")')
                print_info "    Startup Probe: Exec [$PROBE_COMMAND] (cannot test directly)"
            fi
        fi
    done
done

if [[ $HAS_PROBE_ISSUES -eq 0 ]]; then
    update_check_result --status "success" --evidence "{}"
else
    update_check_result --status "failed" --evidence "{}"
fi
