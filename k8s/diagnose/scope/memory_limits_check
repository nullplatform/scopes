#!/bin/bash
# Check: Memory Limits
# Checks for out-of-memory container terminations

PODS=$(kubectl get pods -n "$NAMESPACE" -l "$LABEL_SELECTOR" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)

if [[ -z "$PODS" ]]; then
    print_error "No pods found with $LABEL_SELECTOR"
    update_check_result --status "failed" --evidence "{}"
else
  HAS_OOM=0

  for POD_NAME in $PODS; do
      POD_INFO=$(kubectl get pod "$POD_NAME" -n "$NAMESPACE" -o json 2>/dev/null)

      OOM_KILLED=$(echo "$POD_INFO" | jq -r '.status.containerStatuses[]? | select(.lastState.terminated.reason == "OOMKilled") | .name')

      if [[ -n "$OOM_KILLED" ]]; then
          HAS_OOM=1
          print_error "Pod $POD_NAME: OOMKilled in container(s): $OOM_KILLED"

          for CONTAINER in $OOM_KILLED; do
              MEMORY_LIMIT=$(echo "$POD_INFO" | jq -r ".spec.containers[] | select(.name==\"$CONTAINER\") | .resources.limits.memory // \"not set\"")
              MEMORY_REQUEST=$(echo "$POD_INFO" | jq -r ".spec.containers[] | select(.name==\"$CONTAINER\") | .resources.requests.memory // \"not set\"")

              print_warning "  Container: $CONTAINER"
              print_warning "  Memory Limit: $MEMORY_LIMIT"
              print_warning "  Memory Request: $MEMORY_REQUEST"
              print_info "  Action: Increase memory limits or optimize application memory usage"
          done
      fi
  done

  if [[ $HAS_OOM -eq 0 ]]; then
      update_check_result --status "success" --evidence "{}"
  else
      update_check_result --status "failed" --evidence "{}"
  fi
fi