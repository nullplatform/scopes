#!/bin/bash
# Check: Resource Availability
# Validates pod can be scheduled with requested resources

# Validate pods exist
require_pods || return 0

# Read pods from pre-collected data
PODS=$(jq -r '.items[].metadata.name' "$PODS_FILE" 2>/dev/null | tr '\n' ' ')

HAS_ISSUES=0

for POD_NAME in $PODS; do
    # Get pod info from pre-collected data
    POD_INFO=$(jq --arg name "$POD_NAME" '.items[] | select(.metadata.name == $name)' "$PODS_FILE" 2>/dev/null)
    POD_PHASE=$(echo "$POD_INFO" | jq -r '.status.phase')

    if [[ "$POD_PHASE" == "Pending" ]]; then
        UNSCHEDULABLE=$(echo "$POD_INFO" | jq -r '.status.conditions[] | select(.reason=="Unschedulable") | .message')

        if [[ -n "$UNSCHEDULABLE" ]]; then
            HAS_ISSUES=1
            print_error "Pod $POD_NAME: Cannot be scheduled"
            print_warning "  Reason: $UNSCHEDULABLE"

            if echo "$UNSCHEDULABLE" | grep -qi "insufficient cpu"; then
                print_warning "  Issue: Insufficient CPU in cluster"
            fi

            if echo "$UNSCHEDULABLE" | grep -qi "insufficient memory"; then
                print_warning "  Issue: Insufficient memory in cluster"
            fi

            print_info "  Action: Reduce resource requests or add more nodes to cluster"
        fi
    fi
done

if [[ $HAS_ISSUES -eq 0 ]]; then
    POD_COUNT=$(echo "$PODS" | wc -w)
    print_success "All $POD_COUNT pod(s) successfully scheduled with sufficient resources"
    update_check_result --status "success" --evidence "{}"
else
    update_check_result --status "failed" --evidence "{}"
fi
