#!/bin/bash
# Check: Container Crash Detection
# Checks if containers are crashing on startup

# Validate pods exist
require_pods || return 0

# Read pods from pre-collected data
PODS=$(jq -r '.items[].metadata.name' "$PODS_FILE" 2>/dev/null | tr '\n' ' ')

HAS_CRASHES=0

for POD_NAME in $PODS; do
      # Get pod info from pre-collected data
      POD_INFO=$(jq --arg name "$POD_NAME" '.items[] | select(.metadata.name == $name)' "$PODS_FILE" 2>/dev/null)

      CRASH_LOOP=$(echo "$POD_INFO" | jq -r '.status.containerStatuses[]? | select(.state.waiting.reason == "CrashLoopBackOff") | .name')

      if [[ -n "$CRASH_LOOP" ]]; then
          HAS_CRASHES=1
          print_error "Pod $POD_NAME: CrashLoopBackOff in container(s): $CRASH_LOOP"

          for CONTAINER in $CRASH_LOOP; do
              RESTART_COUNT=$(echo "$POD_INFO" | jq -r ".status.containerStatuses[] | select(.name==\"$CONTAINER\") | .restartCount")
              EXIT_CODE=$(echo "$POD_INFO" | jq -r ".status.containerStatuses[] | select(.name==\"$CONTAINER\") | .lastState.terminated.exitCode // \"N/A\"")

              print_warning "  Container: $CONTAINER | Restarts: $RESTART_COUNT | Exit Code: $EXIT_CODE"

              case "$EXIT_CODE" in
                  137) print_warning "  Exit 137 = OOMKilled (out of memory)" ;;
                  143) print_warning "  Exit 143 = SIGTERM (graceful termination)" ;;
                  1)   print_warning "  Exit 1 = Application error" ;;
              esac
          done

          print_info "Last logs from $POD_NAME:"
          kubectl logs "$POD_NAME" -n "$NAMESPACE" --tail=10 2>&1 | sed 's/^/  /'
          print_info "  Action: Check container logs and fix application startup issues"
      fi
done

if [[ $HAS_CRASHES -eq 0 ]]; then
    POD_COUNT=$(echo "$PODS" | wc -w)
    print_success "All $POD_COUNT pod(s) running without crashes"
    update_check_result --status "success" --evidence "{}"
else
    update_check_result --status "failed" --evidence "{}"
fi
