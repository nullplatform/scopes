#!/bin/bash

SCOPE_ID=$(echo "$CONTEXT" | jq -r '.arguments.scope_id // empty')
K8S_NAMESPACE=${K8S_NAMESPACE:-"nullplatform"}

LOGFILE="$HOME/metric_debug.log"
{
  date
  printf 'SCOPE_ID=%s\n' "$SCOPE_ID"
  printf 'K8S_NAMESPACE=%s\n' "$K8S_NAMESPACE"
  printf 'PROMETHEUS_URL=%s\n' "$PROMETHEUS_URL"
  echo '---'
} >> "$LOGFILE"

if [[ -z "$PROMETHEUS_URL" ]]; then
  NRN=$(np scope read --id "$SCOPE_ID" --format json | jq -r .nrn)

  PROVIDERS=$(np provider list --categories metrics --nrn "$NRN" --format json)

  PROM_URL=$(echo "$PROVIDERS" | jq -r '.results[0].attributes.server.url // empty')
else
  PROM_URL="$PROMETHEUS_URL"
fi

if [[ -z "$PROM_URL" ]]; then
  echo "There is no prometheus provider configured. Please configure prometheus in Platform settings and try again." >&2
  exit 1
fi

while read -r line; do
  eval "$line"
done < <(echo "$CONTEXT" | jq -r '.arguments | to_entries[] |
  if (.value | type) == "array" then
    "export \(.key | ascii_upcase)=\(.value | join(","))"
  else
    "export \(.key | ascii_upcase)=\(.value)"
  end')
if [[ -n "$METRIC" ]]; then
  export METRIC_NAME="$METRIC"
fi

export PROM_URL
export K8S_NAMESPACE
export SCOPE_ID