#!/bin/bash

echo "Waiting for balancer/DNS setup to complete..."

MAX_ITERATIONS=${MAX_ITERATIONS:-30}
iteration=0

case "$DNS_TYPE" in
  external_dns)
    SCOPE_DOMAIN=$(echo "$CONTEXT" | jq -r '.scope.domain')
    SCOPE_SLUG=$(echo "$CONTEXT" | jq -r '.scope.slug')
    SCOPE_ID=$(echo "$CONTEXT" | jq -r '.scope.id')
    
    DNS_ENDPOINT_NAME="k-8-s-${SCOPE_SLUG}-${SCOPE_ID}-dns"
    echo "Checking ExternalDNS record creation for domain: $SCOPE_DOMAIN"
    echo "Waiting for DNSEndpoint: $DNS_ENDPOINT_NAME"

    while true; do
        iteration=$((iteration + 1))
        if [ $iteration -gt $MAX_ITERATIONS ]; then
            echo "⚠️  DNS record creation timeout after $((MAX_ITERATIONS * 10))s"
            echo "ExternalDNS may still be processing the DNSEndpoint resource"
            echo "You can check manually with: kubectl get dnsendpoint $DNS_ENDPOINT_NAME -n $K8S_NAMESPACE -o yaml"
            exit 1
        fi

        echo "Checking DNSEndpoint status (attempt $iteration/$MAX_ITERATIONS)"

        # Get the DNSEndpoint resource and check generation vs observedGeneration
        ENDPOINT_JSON=$(kubectl get dnsendpoint "$DNS_ENDPOINT_NAME" -n "$K8S_NAMESPACE" -o json 2>/dev/null)

        if [ -z "$ENDPOINT_JSON" ]; then
            echo "DNSEndpoint not found yet, waiting 10s..."
            sleep 10
            continue
        fi

        GENERATION=$(echo "$ENDPOINT_JSON" | jq -r '.metadata.generation // 0')
        OBSERVED_GENERATION=$(echo "$ENDPOINT_JSON" | jq -r '.status.observedGeneration // 0')

        echo "DNSEndpoint generation: $GENERATION, observedGeneration: $OBSERVED_GENERATION"

        # Check if ExternalDNS has observed and processed the current generation
        if [ "$GENERATION" -gt 0 ] && [ "$OBSERVED_GENERATION" -ge "$GENERATION" ]; then
            echo "✓ ExternalDNS has processed DNSEndpoint $DNS_ENDPOINT_NAME"
            echo "✓ DNS record for $SCOPE_DOMAIN should now be propagating"
            break
        fi

        echo "ExternalDNS has not yet processed the DNSEndpoint, waiting 10s..."
        sleep 10
    done
    
    echo "✓ ExternalDNS setup completed successfully"
    ;;
  route53|azure)
    echo "DNS Type $DNS_TYPE - DNS should already be configured"
    echo "Skipping DNS wait check"
    ;;
  *)
    echo "Unknown DNS type: $DNS_TYPE"
    echo "Skipping DNS wait check"
    ;;
esac