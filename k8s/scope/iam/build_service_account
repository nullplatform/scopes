#!/bin/bash

set -euo pipefail

IAM=${IAM-"{}"}

IAM_ENABLED=$(echo "$IAM" | jq -r .ENABLED)

if [[ "$IAM_ENABLED" == "false" || "$IAM_ENABLED" == "null" ]]; then
  echo "IAM is not enabled, skipping service account setup"
  return
fi

echo "Getting AWS account ID..."
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text 2>&1) || {
  echo "ERROR: Failed to get AWS account ID"
  echo "AWS Error: $AWS_ACCOUNT_ID"
  echo "Check if AWS credentials are configured correctly"
  exit 1
}

SERVICE_ACCOUNT_NAME=$(echo "$IAM" | jq -r .PREFIX)-"$SCOPE_ID"
echo "Looking for IAM role: $SERVICE_ACCOUNT_NAME"

ROLE_ARN=$(aws iam get-role --role-name "$SERVICE_ACCOUNT_NAME" --query 'Role.Arn' --output text 2>&1) || {
  if [[ "${ACTION:-}" == "delete" ]] && [[ "$ROLE_ARN" == *"NoSuchEntity"* ]] && [[ "$ROLE_ARN" == *"cannot be found"* ]]; then
    echo "IAM role '$SERVICE_ACCOUNT_NAME' does not exist, skipping service account deletion"
    return 0
  fi

  echo "ERROR: Failed to find IAM role '$SERVICE_ACCOUNT_NAME'"
  echo "AWS Error: $ROLE_ARN"
  echo "Make sure the role exists and you have IAM permissions"
  exit 1
}

CONTEXT_PATH="$OUTPUT_DIR/context-$SCOPE_ID.json"
SERVICE_ACCOUNT_PATH="$OUTPUT_DIR/service_account-$SCOPE_ID.yaml"

echo "$CONTEXT" | jq --arg role_arn "$ROLE_ARN" --arg service_account_name "$SERVICE_ACCOUNT_NAME" '. + {role_arn: $role_arn, service_account_name: $service_account_name}' > "$CONTEXT_PATH"

echo "Building Template: $SERVICE_ACCOUNT_TEMPLATE to $SERVICE_ACCOUNT_PATH"
gomplate -c .="$CONTEXT_PATH" \
  --file "$SERVICE_ACCOUNT_TEMPLATE" \
  --out "$SERVICE_ACCOUNT_PATH"

TEMPLATE_GENERATION_STATUS=$?

if [[ $TEMPLATE_GENERATION_STATUS -ne 0 ]]; then
    echo "Error building secret template"
    exit 1
fi

rm "$CONTEXT_PATH"