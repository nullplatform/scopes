#!/bin/bash

# Source utility functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../utils/get_config_value"

K8S_NAMESPACE=$(get_config_value \
  --env NAMESPACE_OVERRIDE \
  --provider '.providers["scope-configuration"].cluster.namespace' \
  --provider '.providers["container-orchestration"].cluster.namespace' \
  --default "nullplatform"
)

# General configuration
DNS_TYPE=$(get_config_value \
  --env DNS_TYPE \
  --provider '.providers["scope-configuration"].networking.dns_type' \
  --default "route53"
)

ALB_RECONCILIATION_ENABLED=$(get_config_value \
  --env ALB_RECONCILIATION_ENABLED \
  --provider '.providers["scope-configuration"].networking.alb_reconciliation_enabled' \
  --default "false"
)

DEPLOYMENT_MAX_WAIT_IN_SECONDS=$(get_config_value \
  --env DEPLOYMENT_MAX_WAIT_IN_SECONDS \
  --provider '.providers["scope-configuration"].deployment.deployment_max_wait_seconds' \
  --default "600"
)

# Build MANIFEST_BACKUP object from flat properties
MANIFEST_BACKUP_ENABLED=$(get_config_value \
  --provider '.providers["scope-configuration"].deployment.manifest_backup_enabled' \
  --default "false"
)
MANIFEST_BACKUP_TYPE=$(get_config_value \
  --provider '.providers["scope-configuration"].deployment.manifest_backup_type' \
  --default ""
)
MANIFEST_BACKUP_BUCKET=$(get_config_value \
  --provider '.providers["scope-configuration"].deployment.manifest_backup_bucket' \
  --default ""
)
MANIFEST_BACKUP_PREFIX=$(get_config_value \
  --provider '.providers["scope-configuration"].deployment.manifest_backup_prefix' \
  --default ""
)

# Use env var if set, otherwise build from individual properties
if [ -n "${MANIFEST_BACKUP:-}" ]; then
  MANIFEST_BACKUP="$MANIFEST_BACKUP"
else
  MANIFEST_BACKUP=$(jq -n \
    --argjson enabled "$MANIFEST_BACKUP_ENABLED" \
    --arg type "$MANIFEST_BACKUP_TYPE" \
    --arg bucket "$MANIFEST_BACKUP_BUCKET" \
    --arg prefix "$MANIFEST_BACKUP_PREFIX" \
    '{ENABLED: $enabled, TYPE: $type, BUCKET: $bucket, PREFIX: $prefix} |
     with_entries(select(.value != "" and .value != null))')
fi

VAULT_ADDR=$(get_config_value \
  --env VAULT_ADDR \
  --provider '.providers["scope-configuration"].security.vault_address' \
  --default ""
)

VAULT_TOKEN=$(get_config_value \
  --env VAULT_TOKEN \
  --provider '.providers["scope-configuration"].security.vault_token' \
  --default ""
)

export DNS_TYPE
export ALB_RECONCILIATION_ENABLED
export DEPLOYMENT_MAX_WAIT_IN_SECONDS
export MANIFEST_BACKUP
export VAULT_ADDR
export VAULT_TOKEN

echo "Validating namespace $K8S_NAMESPACE exists"

if ! kubectl get namespace "$K8S_NAMESPACE" &> /dev/null; then
  echo "Namespace '$K8S_NAMESPACE' does not exist in the cluster."

  CREATE_K8S_NAMESPACE_IF_NOT_EXIST=$(get_config_value \
    --env CREATE_K8S_NAMESPACE_IF_NOT_EXIST \
    --provider '.providers["scope-configuration"].cluster.create_namespace_if_not_exist' \
    --default "true"
  )

  if [ "$CREATE_K8S_NAMESPACE_IF_NOT_EXIST" = "true" ]; then
    echo "Creating namespace '$K8S_NAMESPACE'..."
    
    kubectl create namespace "$K8S_NAMESPACE" --dry-run=client -o yaml | \
      kubectl label -f - nullplatform=true --dry-run=client -o yaml | \
      kubectl apply -f -

    echo "Namespace '$K8S_NAMESPACE' created successfully."
  else
    echo "Error: Namespace '$K8S_NAMESPACE' does not exist and CREATE_K8S_NAMESPACE_IF_NOT_EXIST is set to false."
    exit 1
  fi
fi

USE_ACCOUNT_SLUG=$(get_config_value \
  --provider '.providers["scope-configuration"].networking.application_domain' \
  --provider '.providers["cloud-providers"].networking.application_domain' \
  --default "false"
)

REGION=$(get_config_value \
  --provider '.providers["scope-configuration"].cluster.region' \
  --provider '.providers["cloud-providers"].account.region' \
  --default "us-east-1"
)

SCOPE_VISIBILITY=$(echo "$CONTEXT" | jq -r '.scope.capabilities.visibility')

if [ "$SCOPE_VISIBILITY" = "public" ]; then
    DOMAIN=$(get_config_value \
      --provider '.providers["scope-configuration"].networking.domain_name' \
      --provider '.providers["cloud-providers"].networking.domain_name' \
      --default "nullapps.io"
    )
else
    DOMAIN=$(get_config_value \
      --provider '.providers["scope-configuration"].networking.private_domain_name' \
      --provider '.providers["cloud-providers"].networking.private_domain_name' \
      --provider '.providers["scope-configuration"].networking.domain_name' \
      --provider '.providers["cloud-providers"].networking.domain_name' \
      --default "nullapps.io"
    )
fi
SCOPE_DOMAIN=$(echo "$CONTEXT" | jq .scope.domain -r)

eval "$(echo "$CONTEXT" | jq -r '.scope.nrn | "
export ORGANIZATION_ID=\(capture("organization=(?<id>\\d+)").id)
export ACCOUNT_ID=\(capture("account=(?<id>\\d+)").id)
export NAMESPACE_ID=\(capture("namespace=(?<id>\\d+)").id)
export APPLICATION_ID=\(capture("application=(?<id>\\d+)").id)
"')"

SCOPE_ID=$(echo "$CONTEXT" | jq -r '.scope.id')

export SCOPE_VISIBILITY
export SCOPE_DOMAIN

if [ "$SCOPE_VISIBILITY" = "public" ]; then
    export INGRESS_VISIBILITY="internet-facing"
    GATEWAY_DEFAULT="${PUBLIC_GATEWAY_NAME:-gateway-public}"
    export GATEWAY_NAME=$(get_config_value \
      --provider '.providers["scope-configuration"].networking.gateway_public_name' \
      --provider '.providers["container-orchestration"].gateway.public_name' \
      --default "$GATEWAY_DEFAULT"
    )
else
    export INGRESS_VISIBILITY="internal"
    GATEWAY_DEFAULT="${PRIVATE_GATEWAY_NAME:-gateway-internal}"
    export GATEWAY_NAME=$(get_config_value \
      --provider '.providers["scope-configuration"].networking.gateway_private_name' \
      --provider '.providers["container-orchestration"].gateway.private_name' \
      --default "$GATEWAY_DEFAULT"
    )
fi

K8S_MODIFIERS=$(get_config_value \
  --env K8S_MODIFIERS \
  --provider '.providers["scope-configuration"].object_modifiers.modifiers | @json' \
  --default "{}"
)
K8S_MODIFIERS=$(echo "$K8S_MODIFIERS" | jq .)

ALB_NAME="k8s-nullplatform-$INGRESS_VISIBILITY"

if [ "$INGRESS_VISIBILITY" = "internet-facing" ]; then
    ALB_NAME=$(get_config_value \
      --provider '.providers["scope-configuration"].networking.balancer_public_name' \
      --provider '.providers["container-orchestration"].balancer.public_name' \
      --default "$ALB_NAME"
    )
else
    ALB_NAME=$(get_config_value \
      --provider '.providers["scope-configuration"].networking.balancer_private_name' \
      --provider '.providers["container-orchestration"].balancer.private_name' \
      --default "$ALB_NAME"
    )
fi

NAMESPACE_SLUG=$(echo "$CONTEXT" | jq -r .namespace.slug)
APPLICATION_SLUG=$(echo "$CONTEXT" | jq -r .application.slug)
COMPONENT=$(echo "$NAMESPACE_SLUG-$APPLICATION_SLUG" | sed -E 's/^(.{0,62}[a-zA-Z0-9]).*/\1/')

CONTEXT=$(echo "$CONTEXT" | jq \
          --arg ingress_visibility "$INGRESS_VISIBILITY" \
          --arg k8s_namespace "$K8S_NAMESPACE" \
          --arg region "$REGION" \
          --arg gateway_name "$GATEWAY_NAME" \
          --arg alb_name "$ALB_NAME" \
          --arg component "$COMPONENT" \
          --argjson modifiers "$K8S_MODIFIERS" \
          '. + {ingress_visibility: $ingress_visibility, k8s_namespace: $k8s_namespace, gateway_name: $gateway_name, region: $region, k8s_modifiers: $modifiers, alb_name: $alb_name, component: $component}')

OUTPUT_DIR="$SERVICE_PATH/output/$SCOPE_ID"
if [ -n "${NP_OUTPUT_DIR:-}" ]; then
    OUTPUT_DIR="$NP_OUTPUT_DIR/output/$SCOPE_ID"
fi

export OUTPUT_DIR
export CONTEXT
export REGION

mkdir -p "$OUTPUT_DIR"
