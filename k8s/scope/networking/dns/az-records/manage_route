#!/bin/bash

set -euo pipefail

get_azure_token() {
    echo "Getting Azure access token..."
    local token_response=$(curl -s -X POST \
        "https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "client_id=${AZURE_CLIENT_ID}" \
        -d "client_secret=${AZURE_CLIENT_SECRET}" \
        -d "scope=https://management.azure.com/.default" \
        -d "grant_type=client_credentials" 2>&1) || {
        echo "ERROR: Failed to get Azure access token"
        echo "Curl error: $token_response"
        return 1
    }
    
    local access_token=$(echo "$token_response" | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)
    
    if [[ -z "$access_token" ]]; then
        echo "ERROR: No access token in response"
        echo "Response: $token_response"
        return 1
    fi
    
    echo "$access_token"
}

ACTION=""
GATEWAY_NAME=""
RESOURCE_GROUP=""
AZURE_SUBSCRIPTION_ID=""
HOSTED_ZONE_NAME=""
HOSTED_ZONE_RG=""

for arg in "$@"; do
  case $arg in
    --action=*) ACTION="${arg#*=}" ;;
    --resource-group=*) RESOURCE_GROUP="${arg#*=}" ;;
    --subscription-id=*) AZURE_SUBSCRIPTION_ID="${arg#*=}" ;;
    --gateway-name=*) GATEWAY_NAME="${arg#*=}" ;;
    --hosted-zone-name=*) HOSTED_ZONE_NAME="${arg#*=}" ;;
    --hosted-zone-rg=*) HOSTED_ZONE_RG="${arg#*=}" ;;
  esac
done

echo "Getting IP address for Gateway: $GATEWAY_NAME in namespace: gateways"

# Get IP from Gateway resource ADDRESS column
GATEWAY_IP=$(kubectl get gateway "$GATEWAY_NAME" -n gateways \
    -o jsonpath='{.status.addresses[?(@.type=="IPAddress")].value}' 2>/dev/null)

if [ -z "$GATEWAY_IP" ]; then
    echo "Error: Could not get IP address for gateway $GATEWAY_NAME"
    exit 1
fi

echo "Gateway IP: $GATEWAY_IP"

SCOPE_SUBDOMAIN="${SCOPE_SUBDOMAIN:-}"
if [ -z "$SCOPE_SUBDOMAIN" ]; then
    SCOPE_SUBDOMAIN="${SCOPE_DOMAIN%.$HOSTED_ZONE_NAME}"
fi

echo "Managing DNS record in zone: $HOSTED_ZONE_NAME"


if [ "$ACTION" = "CREATE" ]; then
    echo "Creating record for: $SCOPE_SUBDOMAIN.$HOSTED_ZONE_NAME"

    # Get access token
    ACCESS_TOKEN=$(get_azure_token)

    # Create or update A record
    RECORD_SET_URL="https://management.azure.com/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${HOSTED_ZONE_RG}/providers/Microsoft.Network/dnsZones/${HOSTED_ZONE_NAME}/A/${SCOPE_SUBDOMAIN}?api-version=2018-05-01"

    RECORD_BODY=$(cat <<EOF
{
  "properties": {
    "TTL": 300,
    "ARecords": [
      {
        "ipv4Address": "${GATEWAY_IP}"
      }
    ]
  }
}
EOF
)
    
    echo "Creating Azure DNS record: ${SCOPE_SUBDOMAIN} -> ${GATEWAY_IP}"
    
    AZURE_RESPONSE=$(curl -s -X PUT \
        "${RECORD_SET_URL}" \
        -H "Authorization: Bearer ${ACCESS_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${RECORD_BODY}" 2>&1) || {
        echo "ERROR: Failed to create/update Azure DNS record"
        echo "Curl error: $AZURE_RESPONSE"
        exit 1
    }
    
    # Check if response contains error
    if echo "$AZURE_RESPONSE" | grep -q '"error"'; then
        echo "ERROR: Azure API returned error"
        echo "Response: $AZURE_RESPONSE"
        exit 1
    fi
    
    echo "Record created/updated successfully"
    
elif [ "$ACTION" = "DELETE" ]; then
    echo "Deleting record for: $SCOPE_SUBDOMAIN.$HOSTED_ZONE_NAME"
    
    ACCESS_TOKEN=$(get_azure_token)
    
    RECORD_SET_URL="https://management.azure.com/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${HOSTED_ZONE_RG}/providers/Microsoft.Network/dnsZones/${HOSTED_ZONE_NAME}/A/${SCOPE_SUBDOMAIN}?api-version=2018-05-01"
    
    curl -s -X DELETE \
        "${RECORD_SET_URL}" \
        -H "Authorization: Bearer ${ACCESS_TOKEN}"
    
    echo "Record deleted successfully"
fi