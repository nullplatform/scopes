#!/bin/bash

echo "TEMPLATE DIR: $OUTPUT_DIR, ACTION: $ACTION, DRY_RUN: $DRY_RUN"

APPLIED_FILES=()

# Find all .yaml files that were not yet applied / deleted
while IFS= read -r TEMPLATE_FILE; do
   echo "kubectl $ACTION $TEMPLATE_FILE"

   if [[ "$DRY_RUN" == "false" ]]; then
     IGNORE_NOT_FOUND=""

     if [[ "$ACTION" == "delete" ]]; then
       IGNORE_NOT_FOUND="--ignore-not-found=true"
     fi

     kubectl "$ACTION" -f "$TEMPLATE_FILE" $IGNORE_NOT_FOUND
   fi

   BASE_DIR="$(dirname "$TEMPLATE_FILE")"
   FILENAME="$(basename "$TEMPLATE_FILE")"
   DEST_DIR="${BASE_DIR}/$ACTION"

   mkdir -p "$DEST_DIR"

   mv "$TEMPLATE_FILE" "$DEST_DIR/$FILENAME"

   # Add the moved file path to our array
   APPLIED_FILES+=("$DEST_DIR/$FILENAME")
done < <(find "$OUTPUT_DIR" \( -path "*/apply" -o -path "*/delete" \) -prune -o -type f -name "*.yaml" -print)

if [[ "$DRY_RUN" == "true" ]]; then
  exit 1
fi

source "$SERVICE_PATH/backup/backup_templates" --action="$ACTION" --files "${APPLIED_FILES[@]}"
