#!/bin/bash

echo "ğŸ“ Applying templates..."
echo "ğŸ“‹ Directory: $OUTPUT_DIR"
echo "ğŸ“‹ Action: $ACTION"
echo "ğŸ“‹ Dry run: $DRY_RUN"
echo ""

APPLIED_FILES=()

# Find all .yaml files that were not yet applied / deleted
while IFS= read -r TEMPLATE_FILE; do
   FILENAME="$(basename "$TEMPLATE_FILE")"
   BASE_DIR="$(dirname "$TEMPLATE_FILE")"

   # Check if file is empty or contains only whitespace
   if [[ ! -s "$TEMPLATE_FILE" ]] || [[ -z "$(tr -d '[:space:]' < "$TEMPLATE_FILE")" ]]; then
     echo "ğŸ“‹ Skipping empty template: $FILENAME"
     continue
   fi

   echo "ğŸ“ kubectl $ACTION $FILENAME"

   if [[ "$DRY_RUN" == "false" ]]; then
     IGNORE_NOT_FOUND=""

     if [[ "$ACTION" == "delete" ]]; then
       IGNORE_NOT_FOUND="--ignore-not-found=true"
     fi

     if kubectl "$ACTION" -f "$TEMPLATE_FILE" $IGNORE_NOT_FOUND; then
       echo "   âœ… Applied successfully"
     else
       echo "   âŒ Failed to apply"
     fi
   fi

   DEST_DIR="${BASE_DIR}/$ACTION"

   mkdir -p "$DEST_DIR"

   mv "$TEMPLATE_FILE" "$DEST_DIR/$FILENAME"

   # Add the moved file path to our array
   APPLIED_FILES+=("$DEST_DIR/$FILENAME")
done < <(find "$OUTPUT_DIR" \( -path "*/apply" -o -path "*/delete" \) -prune -o -type f -name "*.yaml" -print)

if [[ "$DRY_RUN" == "true" ]]; then
  echo ""
  echo "ğŸ“‹ Dry run mode - no changes were made"
  exit 1
fi

source "$SERVICE_PATH/backup/backup_templates" --action="$ACTION" --files "${APPLIED_FILES[@]}"
