#!/bin/bash

DEPLOYMENT_PATH="$OUTPUT_DIR/deployment-$SCOPE_ID-$DEPLOYMENT_ID.yaml"
SECRET_PATH="$OUTPUT_DIR/secret-$SCOPE_ID-$DEPLOYMENT_ID.yaml"
SCALING_PATH="$OUTPUT_DIR/scaling-$SCOPE_ID-$DEPLOYMENT_ID.yaml"
SERVICE_TEMPLATE_PATH="$OUTPUT_DIR/service-$SCOPE_ID-$DEPLOYMENT_ID.yaml"
PDB_PATH="$OUTPUT_DIR/pdb-$SCOPE_ID-$DEPLOYMENT_ID.yaml"
CONTEXT_PATH="$OUTPUT_DIR/context-$SCOPE_ID.json"

echo "üìù Building deployment templates..."
echo "üìã Output directory: $OUTPUT_DIR"
echo ""

echo "$CONTEXT" | jq --arg replicas "$REPLICAS" '. + {replicas: $replicas}' > "$CONTEXT_PATH"

echo "üìù Building deployment template..."
gomplate -c .="$CONTEXT_PATH" \
  --file "$DEPLOYMENT_TEMPLATE" \
  --out "$DEPLOYMENT_PATH"

TEMPLATE_GENERATION_STATUS=$?

if [[ $TEMPLATE_GENERATION_STATUS -ne 0 ]]; then
    echo "   ‚ùå Failed to build deployment template"
    exit 1
fi
echo "   ‚úÖ Deployment template: $DEPLOYMENT_PATH"

echo "üìù Building secret template..."
gomplate -c .="$CONTEXT_PATH" \
  --file "$SECRET_TEMPLATE" \
  --out "$SECRET_PATH"

TEMPLATE_GENERATION_STATUS=$?

if [[ $TEMPLATE_GENERATION_STATUS -ne 0 ]]; then
    echo "   ‚ùå Failed to build secret template"
    exit 1
fi
echo "   ‚úÖ Secret template: $SECRET_PATH"

echo "üìù Building scaling template..."
gomplate -c .="$CONTEXT_PATH" \
  --file "$SCALING_TEMPLATE" \
  --out "$SCALING_PATH"

TEMPLATE_GENERATION_STATUS=$?

if [[ $TEMPLATE_GENERATION_STATUS -ne 0 ]]; then
    echo "   ‚ùå Failed to build scaling template"
    exit 1
fi
echo "   ‚úÖ Scaling template: $SCALING_PATH"

echo "üìù Building service template..."
gomplate -c .="$CONTEXT_PATH" \
  --file "$SERVICE_TEMPLATE" \
  --out "$SERVICE_TEMPLATE_PATH"

TEMPLATE_GENERATION_STATUS=$?

if [[ $TEMPLATE_GENERATION_STATUS -ne 0 ]]; then
    echo "   ‚ùå Failed to build service template"
    exit 1
fi
echo "   ‚úÖ Service template: $SERVICE_TEMPLATE_PATH"

echo "üìù Building PDB template..."
gomplate -c .="$CONTEXT_PATH" \
  --file "$PDB_TEMPLATE" \
  --out "$PDB_PATH"

TEMPLATE_GENERATION_STATUS=$?

if [[ $TEMPLATE_GENERATION_STATUS -ne 0 ]]; then
    echo "   ‚ùå Failed to build PDB template"
    exit 1
fi
echo "   ‚úÖ PDB template: $PDB_PATH"

rm "$CONTEXT_PATH"

echo ""
echo "‚ú® All templates built successfully"
