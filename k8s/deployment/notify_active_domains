#!/bin/bash

echo "ðŸ” Checking for custom domains to activate..."

DOMAINS=$(echo "$CONTEXT" | jq .scope.domains)

if [[ "$DOMAINS" == "null" || "$DOMAINS" == "[]" ]]; then
    echo "ðŸ“‹ No domains configured, skipping activation"
    return
fi

DOMAIN_COUNT=$(echo "$DOMAINS" | jq length)
echo "ðŸ“‹ Found $DOMAIN_COUNT custom domain(s) to activate"

echo "$DOMAINS" | jq -r '.[] | "\(.id)|\(.name)"' | while IFS='|' read -r domain_id domain_name; do
    echo "ðŸ“ Activating custom domain: $domain_name..."

    np_output=$(np scope domain patch --id "$domain_id" --body '{"status": "active"}' --format json 2>&1)
    np_status=$?

    if [ $np_status -ne 0 ]; then
        echo "âŒ Failed to activate custom domain: $domain_name" >&2
        echo "ðŸ“‹ Error: $np_output" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - Domain ID $domain_id may not exist" >&2
        echo "   - Insufficient permissions (403 Forbidden)" >&2
        echo "   - API connectivity issues" >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Verify domain exists: np scope domain get --id $domain_id" >&2
        echo "   - Check API token permissions" >&2
        continue
    fi

    echo "âœ… Custom domain activated: $domain_name"
done

echo "âœ¨ Custom domain activation completed"