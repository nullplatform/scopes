#!/bin/bash

# Build scope and tags env variables
source "$SERVICE_PATH/scope/build_context"

BLUE_DEPLOYMENT_ID=$(echo "$CONTEXT" | jq '.scope.current_active_deployment // empty' -r)
SCALING_TYPE=$(echo "$CONTEXT" | jq -r .scope.capabilities.scaling_type)

# TODO(federico.maleh) use current number of pods as base.
if [ "$SCALING_TYPE" = "fixed" ]; then
  REPLICAS=$(echo "$CONTEXT" | jq -r .scope.capabilities.fixed_instances)
else
  REPLICAS=$(echo "$CONTEXT" | jq -r .scope.capabilities.autoscaling.min_replicas)
fi

GREEN_REPLICAS=$REPLICAS
BLUE_REPLICAS=$REPLICAS
SWITCH_TRAFFIC=$(echo "$CONTEXT" | jq -r ".deployment.strategy_data.desired_switched_traffic // 100")

MIN_REPLICAS=$(echo "scale=10; $REPLICAS / 10" | bc)
MIN_REPLICAS=$(echo "$MIN_REPLICAS" | awk '{printf "%d", ($1 == int($1) ? $1 : int($1)+1)}')

DEPLOYMENT_STATUS=$(echo "$CONTEXT" | jq -r ".deployment.status")

validate_status() {
  local action="$1"
  local status="$2"
  local expected_status=""

  case "$action" in
    start-initial|start-blue-green)
      expected_status="creating, waiting_for_instances or running"
      ;;
    switch-traffic)
      expected_status="running or waiting_for_instances"
      ;;
    rollback-deployment)
      expected_status="rolling_back or cancelling"
      ;;
    finalize-blue-green)
      expected_status="finalizing"
      ;;
    delete-deployment)
      expected_status="deleting, rolling_back or cancelling"
      ;;
    *)
      echo "ðŸ“ Running action '$action', any deployment status is accepted"
      return 0
      ;;
  esac

  echo "ðŸ“ Running action '$action' (current status: '$status', expected: $expected_status)"

  case "$action" in
    start-initial|start-blue-green)
      [[ "$status" == "creating" || "$status" == "waiting_for_instances" || "$status" == "running" ]]
      ;;
    switch-traffic)
      [[ "$status" == "running" || "$status" == "waiting_for_instances" ]]
      ;;
    rollback-deployment)
      [[ "$status" == "rolling_back" || "$status" == "cancelling" ]]
      ;;
    finalize-blue-green)
      [[ "$status" == "finalizing" || "$status" == "cancelling" ]]
      ;;
    delete-deployment)
      [[ "$status" == "deleting" || "$status" == "cancelling" || "$status" == "rolling_back" ]]
      ;;
  esac
}

if ! validate_status "$SERVICE_ACTION" "$DEPLOYMENT_STATUS"; then
  echo "âŒ Invalid deployment status '$DEPLOYMENT_STATUS' for action '$SERVICE_ACTION'" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Deployment status changed during workflow execution" >&2
  echo "   - Another action is already running on this deployment" >&2
  echo "   - Deployment was modified externally" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Wait for any in-progress actions to complete" >&2
  echo "   - Check the deployment status in the nullplatform dashboard" >&2
  echo "   - Retry the action once the deployment is in the expected state" >&2
  exit 1
fi

DEPLOY_STRATEGY=$(get_config_value \
  --env DEPLOY_STRATEGY \
  --provider '.providers["scope-configurations"].deployment.deployment_strategy' \
  --default "blue-green"
)

if [ "$DEPLOY_STRATEGY" = "rolling" ] && [ "$DEPLOYMENT_STATUS" = "running" ]; then
  GREEN_REPLICAS=$(echo "scale=10; ($GREEN_REPLICAS * $SWITCH_TRAFFIC) / 100" | bc)
  GREEN_REPLICAS=$(echo "$GREEN_REPLICAS" | awk '{printf "%d", ($1 == int($1) ? $1 : int($1)+1)}')

  BLUE_REPLICAS=$(( REPLICAS - GREEN_REPLICAS ))
  BLUE_REPLICAS=$(( MIN_REPLICAS > BLUE_REPLICAS ? MIN_REPLICAS : BLUE_REPLICAS ))

  # Apply minimum after the blue replica calculation so we do not remove pods with 0% traffic switch.
  GREEN_REPLICAS=$(( MIN_REPLICAS > GREEN_REPLICAS ? MIN_REPLICAS : GREEN_REPLICAS ))
fi

if [[ -n "$PULL_SECRETS" ]]; then
  IMAGE_PULL_SECRETS=$PULL_SECRETS
else
  if [ -n "${IMAGE_PULL_SECRETS:-}" ]; then
    IMAGE_PULL_SECRETS=$(echo "$IMAGE_PULL_SECRETS" | jq .)
  else
    PULL_SECRETS_ENABLED=$(get_config_value \
      --provider '.providers["scope-configurations"].security.image_pull_secrets_enabled' \
      --default "false"
    )
    PULL_SECRETS_LIST=$(get_config_value \
      --provider '.providers["scope-configurations"].security.image_pull_secrets | @json' \
      --default "[]"
    )

    IMAGE_PULL_SECRETS=$(jq -n \
      --argjson enabled "$PULL_SECRETS_ENABLED" \
      --argjson secrets "$PULL_SECRETS_LIST" \
      '{ENABLED: $enabled, SECRETS: $secrets}')
  fi
fi

SCOPE_TRAFFIC_PROTOCOL=$(echo "$CONTEXT" | jq -r .scope.capabilities.protocol)

TRAFFIC_CONTAINER_VERSION="latest"

if [[ "$SCOPE_TRAFFIC_PROTOCOL" == "web_sockets" ]]; then
  TRAFFIC_CONTAINER_VERSION="websocket2"
fi

TRAFFIC_CONTAINER_IMAGE=$(get_config_value \
  --env TRAFFIC_CONTAINER_IMAGE \
  --provider '.providers["scope-configurations"].deployment.traffic_container_image' \
  --default "public.ecr.aws/nullplatform/k8s-traffic-manager:$TRAFFIC_CONTAINER_VERSION"
)

# Pod Disruption Budget configuration
PDB_ENABLED=$(get_config_value \
  --env POD_DISRUPTION_BUDGET_ENABLED \
  --provider '.providers["scope-configurations"].deployment.pod_disruption_budget_enabled' \
  --default "false"
)
PDB_MAX_UNAVAILABLE=$(get_config_value \
  --env POD_DISRUPTION_BUDGET_MAX_UNAVAILABLE \
  --provider '.providers["scope-configurations"].deployment.pod_disruption_budget_max_unavailable' \
  --default "25%"
)

# IAM configuration - build from flat properties or use env var
if [ -n "${IAM:-}" ]; then
  IAM="$IAM"
else
  IAM_ENABLED_RAW=$(get_config_value \
    --provider '.providers["scope-configurations"].security.iam_enabled' \
    --default "false"
  )
  IAM_PREFIX=$(get_config_value \
    --provider '.providers["scope-configurations"].security.iam_prefix' \
    --default ""
  )
  IAM_POLICIES=$(get_config_value \
    --provider '.providers["scope-configurations"].security.iam_policies | @json' \
    --default "[]"
  )
  IAM_BOUNDARY=$(get_config_value \
    --provider '.providers["scope-configurations"].security.iam_boundary_arn' \
    --default ""
  )

  IAM=$(jq -n \
    --argjson enabled "$IAM_ENABLED_RAW" \
    --arg prefix "$IAM_PREFIX" \
    --argjson policies "$IAM_POLICIES" \
    --arg boundary "$IAM_BOUNDARY" \
    '{ENABLED: $enabled, PREFIX: $prefix, ROLE: {POLICIES: $policies, BOUNDARY_ARN: $boundary}} |
     if .ROLE.BOUNDARY_ARN == "" then .ROLE |= del(.BOUNDARY_ARN) else . end |
     if .PREFIX == "" then del(.PREFIX) else . end')
fi

IAM_ENABLED=$(echo "$IAM" | jq -r .ENABLED)

SERVICE_ACCOUNT_NAME=""

if [[ "$IAM_ENABLED" == "true" ]]; then
  SERVICE_ACCOUNT_NAME=$(echo "$IAM" | jq -r .PREFIX)-"$SCOPE_ID"
fi

TRAFFIC_MANAGER_CONFIG_MAP=$(get_config_value \
  --env TRAFFIC_MANAGER_CONFIG_MAP \
  --provider '.providers["scope-configurations"].deployment.traffic_manager_config_map' \
  --default ""
)

if [[ -n "$TRAFFIC_MANAGER_CONFIG_MAP" ]]; then
    echo "ðŸ” Validating ConfigMap '$TRAFFIC_MANAGER_CONFIG_MAP' in namespace '$K8S_NAMESPACE'"

    # Check if the ConfigMap exists
    if ! kubectl get configmap "$TRAFFIC_MANAGER_CONFIG_MAP" -n "$K8S_NAMESPACE" &>/dev/null; then
        echo "âŒ ConfigMap '$TRAFFIC_MANAGER_CONFIG_MAP' does not exist in namespace '$K8S_NAMESPACE'" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - ConfigMap was not created before deployment" >&2
        echo "   - ConfigMap name is misspelled in values.yaml" >&2
        echo "   - ConfigMap was deleted or exists in a different namespace" >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Create the ConfigMap: kubectl create configmap $TRAFFIC_MANAGER_CONFIG_MAP -n $K8S_NAMESPACE --from-file=nginx.conf --from-file=default.conf" >&2
        echo "   - Verify the ConfigMap name in your scope configuration" >&2
        exit 1
    fi
    echo "âœ… ConfigMap '$TRAFFIC_MANAGER_CONFIG_MAP' exists"

    # Check for required keys (subPaths)
    REQUIRED_KEYS=("nginx.conf" "default.conf")

    # Get all keys from the ConfigMap data
    CONFIGMAP_KEYS=$(kubectl get configmap "$TRAFFIC_MANAGER_CONFIG_MAP" -n "$K8S_NAMESPACE" -o go-template='{{range $k, $v := .data}}{{$k}}{{"\n"}}{{end}}')

    for key in "${REQUIRED_KEYS[@]}"; do
        if ! echo "$CONFIGMAP_KEYS" | grep -qx "$key"; then
            echo "âŒ ConfigMap '$TRAFFIC_MANAGER_CONFIG_MAP' is missing required key '$key'" >&2
            echo "ðŸ’¡ Possible causes:" >&2
            echo "   - ConfigMap was created without all required files" >&2
            echo "   - Key name is different from expected: ${REQUIRED_KEYS[*]}" >&2
            echo "ðŸ”§ How to fix:" >&2
            echo "   - Update the ConfigMap to include the missing key '$key'" >&2
            echo "   - Required keys: ${REQUIRED_KEYS[*]}" >&2
            exit 1
        fi
        echo "âœ… Found required key '$key' in ConfigMap"
    done

    echo "âœ¨ ConfigMap '$TRAFFIC_MANAGER_CONFIG_MAP' validation successful"
fi

CONTEXT=$(echo "$CONTEXT" | jq \
          --arg blue_deployment_id "$BLUE_DEPLOYMENT_ID" \
          --arg blue_replicas "$BLUE_REPLICAS" \
          --arg green_replicas "$GREEN_REPLICAS" \
          --arg total_replicas "$REPLICAS" \
          --arg traffic_image "$TRAFFIC_CONTAINER_IMAGE" \
          --argjson pull_secrets "$IMAGE_PULL_SECRETS" \
          --arg pdb_enabled "$PDB_ENABLED" \
          --arg pdb_max_unavailable "$PDB_MAX_UNAVAILABLE" \
          --arg service_account_name "$SERVICE_ACCOUNT_NAME" \
          --arg traffic_manager_config_map "$TRAFFIC_MANAGER_CONFIG_MAP" \
          '. + {blue_deployment_id: $blue_deployment_id,
                blue_replicas: $blue_replicas,
                green_replicas: $green_replicas,
                total_replicas: $total_replicas,
                pull_secrets: $pull_secrets,
                traffic_image: $traffic_image,
                pdb_enabled: $pdb_enabled,
                pdb_max_unavailable: $pdb_max_unavailable,
                service_account_name: $service_account_name,
                traffic_manager_config_map: $traffic_manager_config_map
          }')

DEPLOYMENT_ID=$(echo "$CONTEXT" | jq -r '.deployment.id')

OUTPUT_DIR="$SERVICE_PATH/output/$SCOPE_ID-$DEPLOYMENT_ID"
if [ -n "${NP_OUTPUT_DIR:-}" ]; then
    OUTPUT_DIR="$NP_OUTPUT_DIR/output/$SCOPE_ID-$DEPLOYMENT_ID"
fi

export OUTPUT_DIR
export DEPLOYMENT_ID
export BLUE_DEPLOYMENT_ID

mkdir -p "$OUTPUT_DIR"

echo "âœ¨ Deployment context built successfully"
echo "ðŸ“‹ Deployment ID: $DEPLOYMENT_ID | Replicas: green=$GREEN_REPLICAS, blue=$BLUE_REPLICAS"
