#!/bin/bash

# Build scope and tags env variables
source "$SERVICE_PATH/scope/build_context"

BLUE_DEPLOYMENT_ID=$(echo "$CONTEXT" | jq '.scope.current_active_deployment // empty' -r)
SCALING_TYPE=$(echo "$CONTEXT" | jq -r .scope.capabilities.scaling_type)

# TODO(federico.maleh) use current number of pods as base.
if [ "$SCALING_TYPE" = "fixed" ]; then
  REPLICAS=$(echo "$CONTEXT" | jq -r .scope.capabilities.fixed_instances)
else
  REPLICAS=$(echo "$CONTEXT" | jq -r .scope.capabilities.autoscaling.min_replicas)
fi

GREEN_REPLICAS=$REPLICAS
BLUE_REPLICAS=$REPLICAS
SWITCH_TRAFFIC=$(echo "$CONTEXT" | jq -r ".deployment.strategy_data.desired_switched_traffic // 100")

MIN_REPLICAS=$(echo "scale=10; $REPLICAS / 10" | bc)
MIN_REPLICAS=$(echo "$MIN_REPLICAS" | awk '{printf "%d", ($1 == int($1) ? $1 : int($1)+1)}')

DEPLOYMENT_STATUS=$(echo $CONTEXT | jq -r ".deployment.status")

validate_status() {
  local action="$1"
  local status="$2"
  local expected_status=""

  case "$action" in
    start-initial|start-blue-green)
      expected_status="creating, waiting_for_instances or running"
      ;;
    switch-traffic)
      expected_status="running or waiting_for_instances"
      ;;
    rollback-deployment)
      expected_status="rolling_back"
      ;;
    finalize-blue-green)
      expected_status="finalizing"
      ;;
    delete-deployment)
      expected_status="deleting"
      ;;
    *)
      echo "ðŸ”„ Running action '$action', any deployment status is accepted"
      return 0
      ;;
  esac

  echo "ðŸ”„ Running action '$action' (current status: '$status', expected: $expected_status)"

  case "$action" in
    start-initial|start-blue-green)
      [[ "$status" == "creating" || "$status" == "waiting_for_instances" || "$status" == "running" ]]
      ;;
    switch-traffic)
      [[ "$status" == "running" || "$status" == "waiting_for_instances" ]]
      ;;
    rollback-deployment)
      [[ "$status" == "rolling_back" || "$status" == "cancelling" ]]
      ;;
    finalize-blue-green)
      [[ "$status" == "finalizing" || "$status" == "cancelling" ]]
      ;;
    delete-deployment)
      [[ "$status" == "deleting" || "$status" == "cancelling" ]]
      ;;
  esac
}

if ! validate_status "$SERVICE_ACTION" "$DEPLOYMENT_STATUS"; then
  echo "âŒ Invalid deployment status '$DEPLOYMENT_STATUS' for action '$SERVICE_ACTION'" >&2
  exit 1
fi

if [ "$DEPLOY_STRATEGY" = "rolling" ] && [ "$DEPLOYMENT_STATUS" = "running" ]; then
  GREEN_REPLICAS=$(echo "scale=10; ($GREEN_REPLICAS * $SWITCH_TRAFFIC) / 100" | bc)
  GREEN_REPLICAS=$(echo "$GREEN_REPLICAS" | awk '{printf "%d", ($1 == int($1) ? $1 : int($1)+1)}')

  BLUE_REPLICAS=$(( REPLICAS - GREEN_REPLICAS ))
  BLUE_REPLICAS=$(( MIN_REPLICAS > BLUE_REPLICAS ? MIN_REPLICAS : BLUE_REPLICAS ))

  # Apply minimum after the blue replica calculation so we do not remove pods with 0% traffic switch.
  GREEN_REPLICAS=$(( MIN_REPLICAS > GREEN_REPLICAS ? MIN_REPLICAS : GREEN_REPLICAS ))
fi

if [[ -n "$PULL_SECRETS" ]]; then
  IMAGE_PULL_SECRETS=$PULL_SECRETS
else
  IMAGE_PULL_SECRETS="${IMAGE_PULL_SECRETS:-"{}"}"
  IMAGE_PULL_SECRETS=$(echo "$IMAGE_PULL_SECRETS" | jq .)
fi

SCOPE_TRAFFIC_PROTOCOL=$(echo "$CONTEXT" | jq -r .scope.capabilities.protocol)

TRAFFIC_CONTAINER_VERSION="latest"

if [[ "$SCOPE_TRAFFIC_PROTOCOL" == "web_sockets" ]]; then
  TRAFFIC_CONTAINER_VERSION="websocket2"
fi

TRAFFIC_CONTAINER_IMAGE=${TRAFFIC_CONTAINER_IMAGE:-"public.ecr.aws/nullplatform/k8s-traffic-manager:$TRAFFIC_CONTAINER_VERSION"}

# Pod Disruption Budget configuration
PDB_ENABLED=${POD_DISRUPTION_BUDGET_ENABLED:-"false"}
PDB_MAX_UNAVAILABLE=${POD_DISRUPTION_BUDGET_MAX_UNAVAILABLE:-"25%"}

IAM=${IAM-"{}"}

IAM_ENABLED=$(echo "$IAM" | jq -r .ENABLED)

SERVICE_ACCOUNT_NAME=""

if [[ "$IAM_ENABLED" == "true" ]]; then
  SERVICE_ACCOUNT_NAME=$(echo "$IAM" | jq -r .PREFIX)-"$SCOPE_ID"
fi

CONTEXT=$(echo "$CONTEXT" | jq \
          --arg blue_deployment_id "$BLUE_DEPLOYMENT_ID" \
          --arg blue_replicas "$BLUE_REPLICAS" \
          --arg green_replicas "$GREEN_REPLICAS" \
          --arg total_replicas "$REPLICAS" \
          --arg traffic_image "$TRAFFIC_CONTAINER_IMAGE" \
          --argjson pull_secrets "$IMAGE_PULL_SECRETS" \
          --arg pdb_enabled "$PDB_ENABLED" \
          --arg pdb_max_unavailable "$PDB_MAX_UNAVAILABLE" \
          --arg service_account_name "$SERVICE_ACCOUNT_NAME" \
          '. + {blue_deployment_id: $blue_deployment_id,
                blue_replicas: $blue_replicas,
                green_replicas: $green_replicas,
                total_replicas: $total_replicas,
                pull_secrets: $pull_secrets,
                traffic_image: $traffic_image,
                pdb_enabled: $pdb_enabled,
                pdb_max_unavailable: $pdb_max_unavailable,
                service_account_name: $service_account_name
          }')

DEPLOYMENT_ID=$(echo "$CONTEXT" | jq -r '.deployment.id')

OUTPUT_DIR="$SERVICE_PATH/output/$SCOPE_ID-$DEPLOYMENT_ID"
if [ -n "${NP_OUTPUT_DIR:-}" ]; then
    OUTPUT_DIR="$NP_OUTPUT_DIR/output/$SCOPE_ID-$DEPLOYMENT_ID"
fi

export OUTPUT_DIR
export DEPLOYMENT_ID
export BLUE_DEPLOYMENT_ID

mkdir -p "$OUTPUT_DIR"
