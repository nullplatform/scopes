#!/bin/bash

set -euo pipefail

echo "üîç Starting instance kill operation..."

DEPLOYMENT_ID=$(echo "$CONTEXT" | jq -r '.parameters.deployment_id // .notification.parameters.deployment_id // empty')
INSTANCE_NAME=$(echo "$CONTEXT" | jq -r '.parameters.instance_name // .notification.parameters.instance_name // empty')

if [[ -z "$DEPLOYMENT_ID" ]] && [[ -n "${NP_ACTION_CONTEXT:-}" ]]; then
    DEPLOYMENT_ID=$(echo "$NP_ACTION_CONTEXT" | jq -r '.notification.parameters.deployment_id // empty')
fi

if [[ -z "$INSTANCE_NAME" ]] && [[ -n "${NP_ACTION_CONTEXT:-}" ]]; then
    INSTANCE_NAME=$(echo "$NP_ACTION_CONTEXT" | jq -r '.notification.parameters.instance_name // empty')
fi

if [[ -z "$DEPLOYMENT_ID" ]]; then
    echo "‚ùå deployment_id parameter not found" >&2
    echo "üí° Possible causes:" >&2
    echo "   - Parameter not provided in action request" >&2
    echo "   - Context structure is different than expected" >&2
    echo "üîß How to fix:" >&2
    echo "   - Ensure deployment_id is passed in the action parameters" >&2
    exit 1
fi

if [[ -z "$INSTANCE_NAME" ]]; then
    echo "‚ùå instance_name parameter not found" >&2
    echo "üí° Possible causes:" >&2
    echo "   - Parameter not provided in action request" >&2
    echo "   - Context structure is different than expected" >&2
    echo "üîß How to fix:" >&2
    echo "   - Ensure instance_name is passed in the action parameters" >&2
    exit 1
fi

echo "üìã Deployment ID: $DEPLOYMENT_ID"
echo "üìã Instance name: $INSTANCE_NAME"

SCOPE_ID=$(echo "$CONTEXT" | jq -r '.tags.scope_id // .scope.id // .notification.tags.scope_id // empty')

if [[ -z "$SCOPE_ID" ]] && [[ -n "${NP_ACTION_CONTEXT:-}" ]]; then
    SCOPE_ID=$(echo "$NP_ACTION_CONTEXT" | jq -r '.notification.tags.scope_id // empty')
fi

K8S_NAMESPACE=$(echo "$CONTEXT" | jq -r --arg default "$K8S_NAMESPACE" '
  .providers["container-orchestration"].cluster.namespace // $default
' 2>/dev/null || echo "nullplatform")

if [[ -z "$SCOPE_ID" ]]; then
    echo "‚ùå scope_id not found in context" >&2
    echo "üí° Possible causes:" >&2
    echo "   - Context missing scope information" >&2
    echo "   - Action invoked outside of scope context" >&2
    echo "üîß How to fix:" >&2
    echo "   - Verify the action is invoked with proper scope context" >&2
    exit 1
fi

echo "üìã Scope ID: $SCOPE_ID"
echo "üìã Namespace: $K8S_NAMESPACE"

echo "üîç Verifying pod exists..."
if ! kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
    echo "‚ùå Pod $INSTANCE_NAME not found in namespace $K8S_NAMESPACE" >&2
    echo "üí° Possible causes:" >&2
    echo "   - Pod was already terminated" >&2
    echo "   - Pod name is incorrect" >&2
    echo "   - Pod exists in a different namespace" >&2
    echo "üîß How to fix:" >&2
    echo "   - List pods: kubectl get pods -n $K8S_NAMESPACE -l scope_id=$SCOPE_ID" >&2
    exit 1
fi

echo "üìã Fetching pod details..."
POD_STATUS=$(kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.status.phase}')
POD_NODE=$(kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.spec.nodeName}')
POD_START_TIME=$(kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.status.startTime}')

echo "üìã Pod: $INSTANCE_NAME | Status: $POD_STATUS | Node: $POD_NODE | Started: $POD_START_TIME"

DEPLOYMENT_NAME="d-$SCOPE_ID-$DEPLOYMENT_ID"

POD_DEPLOYMENT=$(kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.metadata.ownerReferences[0].name}' 2>/dev/null || echo "")
if [[ -n "$POD_DEPLOYMENT" ]]; then
    REPLICASET_DEPLOYMENT=$(kubectl get replicaset "$POD_DEPLOYMENT" -n "$K8S_NAMESPACE" -o jsonpath='{.metadata.ownerReferences[0].name}' 2>/dev/null || echo "")
    echo "üìã Pod ownership: ReplicaSet=$POD_DEPLOYMENT -> Deployment=$REPLICASET_DEPLOYMENT"

    if [[ "$REPLICASET_DEPLOYMENT" != "$DEPLOYMENT_NAME" ]]; then
        echo "‚ö†Ô∏è  Pod does not belong to expected deployment $DEPLOYMENT_NAME (continuing anyway)"
    fi
else
    echo "‚ö†Ô∏è  Could not verify pod ownership"
fi

echo "üìù Deleting pod $INSTANCE_NAME with 30s grace period..."
kubectl delete pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" --grace-period=30

echo "üìù Waiting for pod termination..."
kubectl wait --for=delete pod/"$INSTANCE_NAME" -n "$K8S_NAMESPACE" --timeout=60s || echo "‚ö†Ô∏è  Pod deletion timeout reached"

if kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
    POD_STATUS_AFTER=$(kubectl get pod "$INSTANCE_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.status.phase}')
    echo "‚ö†Ô∏è  Pod still exists after deletion attempt (status: $POD_STATUS_AFTER)"
else
    echo "‚úÖ Pod successfully terminated and removed"
fi

echo "üìã Checking deployment status after pod deletion..."
if kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" >/dev/null 2>&1; then
    DESIRED_REPLICAS=$(kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.spec.replicas}')
    READY_REPLICAS=$(kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.status.readyReplicas}')
    AVAILABLE_REPLICAS=$(kubectl get deployment "$DEPLOYMENT_NAME" -n "$K8S_NAMESPACE" -o jsonpath='{.status.availableReplicas}')

    echo "üìã Deployment $DEPLOYMENT_NAME: desired=$DESIRED_REPLICAS, ready=${READY_REPLICAS:-0}, available=${AVAILABLE_REPLICAS:-0}"

    if [[ "$DESIRED_REPLICAS" -gt 0 ]]; then
        echo "üìã Kubernetes will automatically create a replacement pod"
    fi
else
    echo "‚ö†Ô∏è  Deployment $DEPLOYMENT_NAME not found"
fi

echo "‚ú® Instance kill operation completed for $INSTANCE_NAME"