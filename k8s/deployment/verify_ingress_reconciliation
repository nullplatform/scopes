#!/bin/bash

SCOPE_SLUG=$(echo "$CONTEXT" | jq -r .scope.slug)
ALB_NAME=$(echo "$CONTEXT" | jq -r .alb_name)
SCOPE_DOMAIN=$(echo "$CONTEXT" | jq -r .scope.domain)
INGRESS_NAME="k-8-s-$SCOPE_SLUG-$SCOPE_ID-$INGRESS_VISIBILITY"
MAX_WAIT_SECONDS=${MAX_WAIT_SECONDS:-120}
CHECK_INTERVAL=${CHECK_INTERVAL:-10}
elapsed=0

echo "üîç Verifying ingress reconciliation..."
echo "üìã Ingress: $INGRESS_NAME | Namespace: $K8S_NAMESPACE | Timeout: ${MAX_WAIT_SECONDS}s"

ALB_RECONCILIATION_ENABLED="${ALB_RECONCILIATION_ENABLED:-false}"

DEPLOYMENT_STRATEGY=$(echo "$CONTEXT" | jq -r ".deployment.strategy")

if [ "$ALB_RECONCILIATION_ENABLED" = "false" ] && [ "$DEPLOYMENT_STRATEGY" = "blue_green" ]; then
    echo "‚ö†Ô∏è Skipping ALB verification (ALB access needed for blue-green traffic validation)"
    return 0
fi

if [ "$ALB_RECONCILIATION_ENABLED" = "true" ]; then
    echo "üìã ALB validation enabled: $ALB_NAME for domain $SCOPE_DOMAIN"
else
    echo "üìã ALB reconciliation disabled, checking cluster events only"
fi

INGRESS_JSON=$(kubectl get ingress "$INGRESS_NAME" -n "$K8S_NAMESPACE" -o json 2>/dev/null)

if [ $? -ne 0 ]; then
    echo "‚ùå Failed to get ingress $INGRESS_NAME"
    echo "üí° Possible causes:"
    echo "   - Ingress does not exist yet"
    echo "   - Namespace $K8S_NAMESPACE is incorrect"
    echo "üîß How to fix:"
    echo "   - List ingresses: kubectl get ingress -n $K8S_NAMESPACE"
    exit 1
fi

current_resource_version=$(echo "$INGRESS_JSON" | jq -r '.metadata.resourceVersion')

SWITCH_TRAFFIC=$(echo "$CONTEXT" | jq -r ".deployment.strategy_data.desired_switched_traffic // 100")

ALL_DOMAINS=("$SCOPE_DOMAIN")
ADDITIONAL_DOMAINS=$(echo "$CONTEXT" | jq -r '.scope.domains[]?.name // empty' 2>/dev/null)
if [ -n "$ADDITIONAL_DOMAINS" ]; then
    while IFS= read -r domain; do
        [ -n "$domain" ] && ALL_DOMAINS+=("$domain")
    done <<< "$ADDITIONAL_DOMAINS"
fi

if [ "$ALB_RECONCILIATION_ENABLED" = "true" ]; then
    ALB_ARN=$(aws elbv2 describe-load-balancers \
            --names "$ALB_NAME" \
            --region "$REGION" \
            --query 'LoadBalancers[0].LoadBalancerArn' \
            --output text 2>&1)

    if [ $? -ne 0 ] || [ "$ALB_ARN" == "None" ] || [ -z "$ALB_ARN" ]; then
        echo "‚ö†Ô∏è  Could not find ALB: $ALB_NAME"
        return 1
    fi
fi

validate_alb_config() {
    LISTENERS=$(aws elbv2 describe-listeners \
        --load-balancer-arn "$ALB_ARN" \
        --region "$REGION" \
        --output json 2>&1)

    if [ $? -ne 0 ]; then
        echo "‚ö†Ô∏è  Could not get listeners for ALB"
        return 1
    fi

    local all_domains_found=true

    for domain in "${ALL_DOMAINS[@]}"; do
        echo "üìù Checking domain: $domain"
        local domain_found=false

        LISTENER_ARNS=$(echo "$LISTENERS" | jq -r '.Listeners[].ListenerArn')

        for listener_arn in $LISTENER_ARNS; do
            RULES=$(aws elbv2 describe-rules \
                --listener-arn "$listener_arn" \
                --region "$REGION" \
                --output json 2>&1)

            if [ $? -ne 0 ]; then
                continue
            fi

            MATCHING_RULE=$(echo "$RULES" | jq --arg domain "$domain" '
                .Rules[] | select(
                    .Conditions[]? |
                    select(.Field == "host-header") |
                    .Values[]? == $domain
                )
            ')

            if [ -n "$MATCHING_RULE" ]; then
                echo "   ‚úÖ Found rule for domain: $domain"

                if [ "${VERIFY_WEIGHTS:-false}" = "true" ]; then
                    BLUE_WEIGHT=$((100 - SWITCH_TRAFFIC))
                    GREEN_WEIGHT=$SWITCH_TRAFFIC

                    BLUE_DEPLOYMENT_ID=$(echo "$CONTEXT" | jq -r '.scope.current_active_deployment // empty')
                    if [ -n "$BLUE_DEPLOYMENT_ID" ]; then
                        EXPECTED_WEIGHTS=$(printf "%s\n%s" "$BLUE_WEIGHT" "$GREEN_WEIGHT" | sort -n)
                    else
                        EXPECTED_WEIGHTS="$GREEN_WEIGHT"
                    fi

                    ACTUAL_WEIGHTS=$(echo "$MATCHING_RULE" | jq -r '
                        .Actions[]? |
                        select(.Type == "forward") |
                        .ForwardConfig.TargetGroups[]? |
                        "\(.Weight // 1)"
                    ' 2>/dev/null | sort -n)

                    if [ -n "$EXPECTED_WEIGHTS" ] && [ -n "$ACTUAL_WEIGHTS" ]; then
                        if [ "$EXPECTED_WEIGHTS" == "$ACTUAL_WEIGHTS" ]; then
                            echo "   ‚úÖ Weights match (GREEN: $GREEN_WEIGHT, BLUE: $BLUE_WEIGHT)"
                            domain_found=true
                        else
                            echo "   ‚ùå Weights mismatch: expected=$EXPECTED_WEIGHTS actual=$ACTUAL_WEIGHTS"
                            domain_found=false
                        fi
                    else
                        echo "   ‚ö†Ô∏è  Could not extract weights for comparison"
                        domain_found=false
                    fi
                else
                    domain_found=true
                fi
                break
            fi
        done

        if [ "$domain_found" = false ]; then
            echo "   ‚ùå Domain not found in ALB rules: $domain"
            all_domains_found=false
        fi
    done

    if [ "$all_domains_found" = true ]; then
        echo "‚úÖ All domains configured in ALB"
        return 0
    else
        echo "‚ö†Ô∏è  Some domains missing from ALB configuration"
        return 1
    fi
}

while [ $elapsed -lt $MAX_WAIT_SECONDS ]; do
    if [ "$ALB_RECONCILIATION_ENABLED" = "true" ]; then
        if validate_alb_config; then
            echo "‚úÖ ALB configuration validated successfully"
            return 0
        fi
        echo "üìù ALB validation incomplete, checking Kubernetes events..."
    fi

    events_json=$(kubectl get events -n "$K8S_NAMESPACE" \
        --field-selector "involvedObject.name=$INGRESS_NAME,involvedObject.kind=Ingress" \
        -o json)

    relevant_events=$(echo "$events_json" | jq --arg rv "$current_resource_version" '
          .items | map(select((.involvedObject.resourceVersion | tonumber) >= ($rv | tonumber)))
      ')

    event_count=$(echo "$relevant_events" | jq 'length')

    if [ "$event_count" -gt 0 ]; then
        newest_event=$(echo "$relevant_events" | jq -r 'sort_by(.lastTimestamp) | last')
        event_type=$(echo "$newest_event" | jq -r '.type')
        event_reason=$(echo "$newest_event" | jq -r '.reason')
        event_message=$(echo "$newest_event" | jq -r '.message')

        if [ "$event_reason" == "SuccessfullyReconciled" ]; then
            echo "‚úÖ Ingress successfully reconciled"
            return 0
        fi

        if echo "$event_message" | grep -q "no certificate found for host"; then
            echo "‚ùå Certificate error detected"
            echo "üí° Possible causes:"
            echo "   - Ingress hostname does not match any SSL/TLS certificate in ACM"
            echo "   - Certificate does not cover the hostname (check wildcards)"
            echo "   - Message: $event_message"
            echo "üîß How to fix:"
            echo "   - Verify hostname matches certificate in ACM"
            echo "   - Ensure certificate includes exact hostname or matching wildcard"
            exit 1
        fi

        if [ "$event_type" == "Error" ]; then
            echo "‚ùå Ingress reconciliation failed"
            echo "üí° Error messages:"
            echo "$relevant_events" | jq -r '.[] | "   - \(.message)"'
            exit 1
        fi

        if [ "$event_type" == "Warning" ]; then
            echo "‚ö†Ô∏è  Potential issues with ingress:"
            echo "$relevant_events" | jq -r '.[] | "   - \(.message)"'
        fi
    fi

    echo "üìù Waiting for ALB reconciliation... (${elapsed}s/${MAX_WAIT_SECONDS}s)"
    sleep $CHECK_INTERVAL
    elapsed=$((elapsed + CHECK_INTERVAL))
done

echo "‚ùå Timeout waiting for ingress reconciliation after ${MAX_WAIT_SECONDS}s"
echo "üí° Possible causes:"
echo "   - ALB Ingress Controller not running or unhealthy"
echo "   - Network connectivity issues"
echo "üîß How to fix:"
echo "   - Check controller: kubectl logs -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller"
echo "   - Check ingress: kubectl describe ingress $INGRESS_NAME -n $K8S_NAMESPACE"
echo "üìã Recent events:"

events_json=$(kubectl get events -n "$K8S_NAMESPACE" \
    --field-selector "involvedObject.name=$INGRESS_NAME,involvedObject.kind=Ingress" \
    -o json)
echo "$events_json" | jq -r '.items | sort_by(.lastTimestamp) | .[] | "  [\(.type)] \(.reason): \(.message)"' | tail -10

exit 1