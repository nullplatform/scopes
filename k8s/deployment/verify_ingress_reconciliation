#!/bin/bash

SCOPE_SLUG=$(echo "$CONTEXT" | jq -r .scope.slug)

INGRESS_NAME="k-8-s-$SCOPE_SLUG-$SCOPE_ID-$INGRESS_VISIBILITY"
MAX_WAIT_SECONDS=120
CHECK_INTERVAL=10
elapsed=0

echo "Waiting for ingress [$INGRESS_NAME] reconciliation..."

current_resource_version=$(kubectl get ingress "$INGRESS_NAME" -n "$K8S_NAMESPACE" -o json | jq -r '.metadata.resourceVersion')

sleep $CHECK_INTERVAL

while [ $elapsed -lt $MAX_WAIT_SECONDS ]; do
    events_json=$(kubectl get events -n "$K8S_NAMESPACE" \
        --field-selector "involvedObject.name=$INGRESS_NAME,involvedObject.kind=Ingress" \
        -o json)

    relevant_events=$(echo "$events_json" | jq --arg rv "$current_resource_version" '
          .items | map(select((.involvedObject.resourceVersion | tonumber) >= ($rv | tonumber)))
      ')

    event_count=$(echo "$relevant_events" | jq 'length')

    if [ "$event_count" -eq 0 ]; then
        echo "Ingress is pending sync (no events yet). Waiting..."
        sleep $CHECK_INTERVAL
        elapsed=$((elapsed + CHECK_INTERVAL))
        continue
    fi

    newest_event=$(echo "$relevant_events" | jq -r 'sort_by(.lastTimestamp) | last')
    event_type=$(echo "$newest_event" | jq -r '.type')
    event_reason=$(echo "$newest_event" | jq -r '.reason')
    event_message=$(echo "$newest_event" | jq -r '.message')

    if [ "$event_reason" == "SuccessfullyReconciled" ]; then
        echo "✓ Ingress was successfully reconciled"
        return 0
    fi

    if echo "$event_message" | grep -q "no certificate found for host"; then
        echo "✗ Certificate error detected"
        echo "Root cause: The ingress hostname does not match any available SSL/TLS certificate"
        echo "Message: $event_message"

        echo "To fix this issue:"
        echo "  1. Verify the hostname in your ingress matches a certificate in ACM (AWS Certificate Manager)"
        echo "  2. Check the 'alb.ingress.kubernetes.io/certificate-arn' annotation points to a valid certificate"
        echo "  3. Ensure the certificate includes the exact hostname or a wildcard that covers it"
        exit 1
    fi

    if [ "$event_type" == "Error" ]; then
        echo "✗ The ingress could not be reconciled"
        echo "Error messages:"
        echo "$relevant_events" | jq -r '.[] | "  - \(.message)"'
        exit 1
    fi

    if [ "$event_type" == "Warning" ]; then
        echo "⚠ There are some potential issues with the ingress"
        echo "Warning messages:"
        echo "$relevant_events" | jq -r '.[] | "  - \(.message)"'
        echo "Waiting for reconciliation to complete..."
        sleep $CHECK_INTERVAL
        elapsed=$((elapsed + CHECK_INTERVAL))
        continue
    fi

    echo "Ingress is pending sync. Waiting..."
    sleep $CHECK_INTERVAL
    elapsed=$((elapsed + CHECK_INTERVAL))
done

echo "✗ Timeout waiting for ingress reconciliation after ${MAX_WAIT_SECONDS} seconds"
echo "Verify your ALB Ingress Controller logs to see why it is not running"
exit 1