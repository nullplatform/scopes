#!/bin/bash

SCOPE_SLUG=$(echo "$CONTEXT" | jq -r .scope.slug)

HTTPROUTE_NAME="k-8-s-$SCOPE_SLUG-$SCOPE_ID-$INGRESS_VISIBILITY"
MAX_WAIT_SECONDS=${MAX_WAIT_SECONDS:-120}
CHECK_INTERVAL=${CHECK_INTERVAL:-10}
elapsed=0

echo "ðŸ” Verifying HTTPRoute reconciliation..."
echo "ðŸ“‹ HTTPRoute: $HTTPROUTE_NAME | Namespace: $K8S_NAMESPACE | Timeout: ${MAX_WAIT_SECONDS}s"

while [ $elapsed -lt $MAX_WAIT_SECONDS ]; do
    sleep $CHECK_INTERVAL

    httproute_json=$(kubectl get httproute "$HTTPROUTE_NAME" -n "$K8S_NAMESPACE" -o json)

    parents_count=$(echo "$httproute_json" | jq '.status.parents | length // 0')

    if [ "$parents_count" -eq 0 ]; then
        echo "ðŸ“ HTTPRoute pending sync (no parent status yet)... (${elapsed}s/${MAX_WAIT_SECONDS}s)"
        elapsed=$((elapsed + CHECK_INTERVAL))
        continue
    fi

    conditions=$(echo "$httproute_json" | jq -r '.status.parents[0].conditions // []')
    conditions_count=$(echo "$conditions" | jq 'length')

    if [ "$conditions_count" -eq 0 ]; then
        echo "ðŸ“ HTTPRoute pending sync (no conditions yet)... (${elapsed}s/${MAX_WAIT_SECONDS}s)"
        elapsed=$((elapsed + CHECK_INTERVAL))
        continue
    fi

    accepted_status=$(echo "$conditions" | jq -r '.[] | select(.type=="Accepted") | .status')
    accepted_reason=$(echo "$conditions" | jq -r '.[] | select(.type=="Accepted") | .reason')
    accepted_message=$(echo "$conditions" | jq -r '.[] | select(.type=="Accepted") | .message')

    resolved_status=$(echo "$conditions" | jq -r '.[] | select(.type=="ResolvedRefs") | .status')
    resolved_reason=$(echo "$conditions" | jq -r '.[] | select(.type=="ResolvedRefs") | .reason')
    resolved_message=$(echo "$conditions" | jq -r '.[] | select(.type=="ResolvedRefs") | .message')

    if [ "$accepted_status" == "True" ] && [ "$resolved_status" == "True" ]; then
        echo "âœ… HTTPRoute successfully reconciled (Accepted: True, ResolvedRefs: True)"
        return 0
    fi

    # Check for certificate/TLS errors
    if echo "$accepted_message $resolved_message" | grep -qi "certificate\|tls\|secret.*not found"; then
        echo "âŒ Certificate/TLS error detected" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - TLS secret does not exist in namespace $K8S_NAMESPACE" >&2
        echo "   - Certificate is invalid or expired" >&2
        echo "   - Gateway references incorrect certificate secret" >&2
        [ "$accepted_status" == "False" ] && echo "   - Accepted: $accepted_reason - $accepted_message" >&2
        [ "$resolved_status" == "False" ] && echo "   - ResolvedRefs: $resolved_reason - $resolved_message" >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Verify TLS secret: kubectl get secret -n $K8S_NAMESPACE | grep tls" >&2
        echo "   - Check certificate validity" >&2
        echo "   - Ensure Gateway references the correct secret" >&2
        exit 1
    fi

    # Check for backend service errors
    if echo "$resolved_message" | grep -qi "service.*not found\|backend.*not found"; then
        echo "âŒ Backend service error detected" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - Referenced service does not exist" >&2
        echo "   - Service name is misspelled in HTTPRoute" >&2
        echo "   - Message: $resolved_message" >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - List services: kubectl get svc -n $K8S_NAMESPACE" >&2
        echo "   - Verify backend service name in HTTPRoute" >&2
        echo "   - Ensure service has ready endpoints" >&2
        exit 1
    fi

    # Accepted=False is an error
    if [ "$accepted_status" == "False" ]; then
        echo "âŒ HTTPRoute not accepted by Gateway" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - Reason: $accepted_reason" >&2
        echo "   - Message: $accepted_message" >&2
        echo "ðŸ“‹ All conditions:" >&2
        echo "$conditions" | jq -r '.[] | "   - \(.type): \(.status) (\(.reason)) - \(.message)"' >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Check Gateway configuration" >&2
        echo "   - Verify HTTPRoute spec matches Gateway requirements" >&2
        exit 1
    fi

    # ResolvedRefs=False is an error
    if [ "$resolved_status" == "False" ]; then
        echo "âŒ HTTPRoute references could not be resolved" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - Reason: $resolved_reason" >&2
        echo "   - Message: $resolved_message" >&2
        echo "ðŸ“‹ All conditions:" >&2
        echo "$conditions" | jq -r '.[] | "   - \(.type): \(.status) (\(.reason)) - \(.message)"' >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Verify all referenced services exist" >&2
        echo "   - Check backend service ports match" >&2
        exit 1
    fi

    echo "ðŸ“ HTTPRoute reconciling... (${elapsed}s/${MAX_WAIT_SECONDS}s)"
    echo "$conditions" | jq -r '.[] | "   - \(.type): \(.status) (\(.reason))"'
    elapsed=$((elapsed + CHECK_INTERVAL))
done

echo "âŒ Timeout waiting for HTTPRoute reconciliation after ${MAX_WAIT_SECONDS}s" >&2
echo "ðŸ’¡ Possible causes:" >&2
echo "   - Gateway controller is not running" >&2
echo "   - Network policies blocking reconciliation" >&2
echo "   - Resource constraints on controller" >&2
echo "ðŸ“‹ Current conditions:" >&2
httproute_json=$(kubectl get httproute "$HTTPROUTE_NAME" -n "$K8S_NAMESPACE" -o json)
echo "$httproute_json" | jq -r '.status.parents[0].conditions[] | "   - \(.type): \(.status) (\(.reason)) - \(.message)"' >&2
echo "ðŸ”§ How to fix:" >&2
echo "   - Check Gateway controller logs" >&2
echo "   - Verify Gateway and Istio configuration" >&2
exit 1