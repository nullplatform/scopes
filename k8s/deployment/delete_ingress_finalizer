#!/bin/bash

echo "ðŸ” Checking for ingress finalizers to remove..."

INGRESS_NAME=$(echo "$CONTEXT" | jq -r '"k-8-s-" + .scope.slug + "-" + (.scope.id | tostring) + "-" + .ingress_visibility')
echo "ðŸ“‹ Ingress name: $INGRESS_NAME"

# If the scope uses ingress, remove any finalizers attached to it
if kubectl get ingress "$INGRESS_NAME" -n "$K8S_NAMESPACE" &>/dev/null; then
  echo "ðŸ“ Removing finalizers from ingress $INGRESS_NAME..."
  if ! kubectl patch ingress "$INGRESS_NAME" -n "$K8S_NAMESPACE" -p '{"metadata":{"finalizers":[]}}' --type=merge; then
    echo "âŒ Failed to remove finalizers from ingress $INGRESS_NAME" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Ingress was deleted while patching" >&2
    echo "   - Insufficient permissions to patch ingress" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify ingress still exists: kubectl get ingress $INGRESS_NAME -n $K8S_NAMESPACE" >&2
    echo "   - Check RBAC permissions for patching ingress resources" >&2
    exit 1
  fi
  echo "âœ… Finalizers removed from ingress $INGRESS_NAME"
else
  echo "ðŸ“‹ Ingress $INGRESS_NAME not found, skipping finalizer removal"
fi