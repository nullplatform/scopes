#!/bin/bash

TEMPLATE=""

for arg in "$@"; do
  case $arg in
    --template=*) TEMPLATE="${arg#*=}" ;;
  esac
done

if [ -z "$TEMPLATE" ]; then
    echo "âŒ Template argument is required" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Missing --template= argument" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Provide template: --template=/path/to/template.yaml" >&2
    exit 1
fi

echo "ðŸ” Creating $INGRESS_VISIBILITY ingress..."

INGRESS_FILE="$OUTPUT_DIR/ingress-$SCOPE_ID-$DEPLOYMENT_ID.yaml"
CONTEXT_PATH="$OUTPUT_DIR/context-$SCOPE_ID.json"

echo "ðŸ“‹ Scope: $SCOPE_ID | Deployment: $DEPLOYMENT_ID"
echo "ðŸ“‹ Template: $TEMPLATE"
echo "ðŸ“‹ Output: $INGRESS_FILE"

echo "$CONTEXT" > "$CONTEXT_PATH"

echo "ðŸ“ Building ingress template..."

if ! gomplate -c .="$CONTEXT_PATH" \
  --file "$TEMPLATE" \
  --out "$INGRESS_FILE" 2>&1; then
    echo "âŒ Failed to build ingress template" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Template file does not exist or is invalid" >&2
    echo "   - Scope attributes may be missing" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify template exists: ls -la $TEMPLATE" >&2
    echo "   - Verify that your scope has all required attributes" >&2
    rm -f "$CONTEXT_PATH"
    exit 1
fi

rm "$CONTEXT_PATH"

echo "âœ… Ingress template created: $INGRESS_FILE"
