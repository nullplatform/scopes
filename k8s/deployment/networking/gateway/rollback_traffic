#!/bin/bash

echo "üîç Rolling back traffic to previous deployment..."

export NEW_DEPLOYMENT_ID=$DEPLOYMENT_ID
BLUE_DEPLOYMENT_ID=$(echo "$CONTEXT" | jq .scope.current_active_deployment -r)

echo "üìã Current deployment: $NEW_DEPLOYMENT_ID"
echo "üìã Rollback target: $BLUE_DEPLOYMENT_ID"

export DEPLOYMENT_ID="$BLUE_DEPLOYMENT_ID"

CONTEXT=$(echo "$CONTEXT" | jq \
  --arg deployment_id "$DEPLOYMENT_ID" \
  '.deployment.id = $deployment_id')

echo "üìù Creating ingress for rollback deployment..."

source "$SERVICE_PATH/deployment/networking/gateway/route_traffic"

export DEPLOYMENT_ID=$NEW_DEPLOYMENT_ID

CONTEXT=$(echo "$CONTEXT" | jq \
  --arg deployment_id "$DEPLOYMENT_ID" \
  '.deployment.id = $deployment_id')

echo "‚úÖ Traffic rollback configuration created"
