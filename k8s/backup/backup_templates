#!/bin/bash

MANIFEST_BACKUP=${MANIFEST_BACKUP-"{}"}

BACKUP_ENABLED=$(echo "$MANIFEST_BACKUP" | jq -r .ENABLED)
TYPE=$(echo "$MANIFEST_BACKUP" | jq -r .TYPE)

if [[ "$BACKUP_ENABLED" == "false" || "$BACKUP_ENABLED" == "null" ]]; then
  echo "üìã Manifest backup is disabled, skipping"
  return
fi


ACTION=""
FILES=()

while [[ $# -gt 0 ]]; do
  case $1 in
    --action=*)
      ACTION="${1#*=}"
      shift
      ;;
    --files)
      shift
      # Collect all remaining arguments as files
      while [[ $# -gt 0 && $1 != --* ]]; do
        FILES+=("$1")
        shift
      done
      ;;
    *)
      shift
      ;;
  esac
done


case "$TYPE" in
  s3)
    source "$SERVICE_PATH/backup/s3" --action="$ACTION" --files "${FILES[@]}"
    ;;
  *)
    echo "‚ùå Unsupported manifest backup type: '$TYPE'"
    echo ""
    echo "üí° Possible causes:"
    echo "   The MANIFEST_BACKUP.TYPE configuration is invalid"
    echo ""
    echo "üîß How to fix:"
    echo "   ‚Ä¢ Set MANIFEST_BACKUP.TYPE to 's3' in values.yaml"
    echo ""
    exit 1
    ;;
esac
