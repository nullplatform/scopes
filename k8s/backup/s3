#!/bin/bash

ACTION=""
FILES=()

while [[ $# -gt 0 ]]; do
  case $1 in
    --action=*)
      ACTION="${1#*=}"
      shift
      ;;
    --files)
      shift
      # Collect all remaining arguments as files
      while [[ $# -gt 0 && $1 != --* ]]; do
        FILES+=("$1")
        shift
      done
      ;;
    *)
      shift
      ;;
  esac
done

BUCKET=$(echo "$MANIFEST_BACKUP" | jq -r .BUCKET)
PREFIX=$(echo "$MANIFEST_BACKUP" | jq -r .PREFIX)

echo "ğŸ“ Starting S3 manifest backup..."
echo "ğŸ“‹ Action: $ACTION"
echo "ğŸ“‹ Bucket: $BUCKET"
echo "ğŸ“‹ Prefix: $PREFIX"
echo "ğŸ“‹ Files: ${#FILES[@]}"
echo ""

# Now you can iterate over the files
for file in "${FILES[@]}"; do
  echo "ğŸ“ Processing: $(basename "$file")"

  # Extract the path after 'output/' and remove the action folder (apply/delete)
  # Example: /root/.np/services/k8s/output/1862688057-34121609/apply/secret-1862688057-34121609.yaml
  # Result: 1862688057-34121609/secret-1862688057-34121609.yaml

  # Get everything after 'output/'
  relative_path="${file#*/output/}"

  # Remove the action folder (apply or delete) from the path
  # Split by '/' and reconstruct without the action folder
  IFS='/' read -ra path_parts <<< "$relative_path"

  # Skip the action folder (second element) and reconstruct the path
  s3_path="${path_parts[0]}/${path_parts[2]}"

  # Full S3 key with prefix
  s3_key="$PREFIX/$s3_path"

  # Remove leading slash if present
  s3_key="${s3_key#/}"


  if [[ "$ACTION" == "apply" ]]; then
    echo "   ğŸ“¡ Uploading to s3://$BUCKET/$s3_key"

    # Upload to S3
    if aws s3 cp --region "$REGION" "$file" "s3://$BUCKET/$s3_key" >/dev/null; then
      echo "   âœ… Upload successful"
    else
      echo "   âŒ Upload failed"
      echo ""
      echo "ğŸ’¡ Possible causes:"
      echo "   â€¢ S3 bucket does not exist or is not accessible"
      echo "   â€¢ IAM permissions are missing for s3:PutObject"
      echo ""
      echo "ğŸ”§ How to fix:"
      echo "   â€¢ Verify bucket '$BUCKET' exists and is accessible"
      echo "   â€¢ Check IAM permissions for the agent"
      echo ""
      exit 1
    fi

  elif [[ "$ACTION" == "delete" ]]; then
    echo "   ğŸ“¡ Deleting s3://$BUCKET/$s3_key"

    # Delete from S3 with error handling
    aws_output=$(aws s3 rm --region "$REGION" "s3://$BUCKET/$s3_key" 2>&1)
    aws_exit_code=$?

    if [[ $aws_exit_code -eq 0 ]]; then
      echo "   âœ… Deletion successful"
    elif [[ "$aws_output" == *"NoSuchKey"* ]] || [[ "$aws_output" == *"Not Found"* ]]; then
      echo "   ğŸ“‹ File not found in S3, skipping"
    else
      echo "   âŒ Deletion failed"
      echo "ğŸ“‹ AWS Error: $aws_output"
      echo ""
      echo "ğŸ’¡ Possible causes:"
      echo "   â€¢ S3 bucket does not exist or is not accessible"
      echo "   â€¢ IAM permissions are missing for s3:DeleteObject"
      echo ""
      echo "ğŸ”§ How to fix:"
      echo "   â€¢ Verify bucket '$BUCKET' exists and is accessible"
      echo "   â€¢ Check IAM permissions for the agent"
      echo ""
      exit 1
    fi

  else
    echo "âŒ Invalid action: '$ACTION'"
    echo ""
    echo "ğŸ’¡ Possible causes:"
    echo "   The action parameter must be 'apply' or 'delete'"
    echo ""
    exit 1
  fi
done

echo ""
echo "âœ¨ S3 backup operation completed successfully"
