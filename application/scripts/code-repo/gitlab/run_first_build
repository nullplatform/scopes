#!/bin/bash

PIPELINE_RESPONSE=$(curl -s --request POST --header "PRIVATE-TOKEN: $GITLAB_ACCESS_TOKEN" \
  "${GITLAB_INSTALLATION_URL}/api/v4/projects/${GITLAB_PROJECT_ID}/pipeline?ref=main" 2>&1 || echo "")

if echo "$PIPELINE_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
  echo "Pipeline triggered successfully"
else
  echo "Could not trigger pipeline directly, trying to create a commit..."
  
  # Create an empty commit to trigger CI
  COMMIT_RESPONSE=$(curl -s --request POST --header "PRIVATE-TOKEN: $GITLAB_ACCESS_TOKEN" \
    --header "Content-Type: application/json" \
    --data "{
      \"branch\": \"main\",
      \"commit_message\": \"Trigger CI\",
      \"actions\": []
    }" \
    "${GITLAB_INSTALLATION_URL}/api/v4/projects/${GITLAB_PROJECT_ID}/repository/commits")
  
  if echo "$COMMIT_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
    echo "Commit created to trigger CI"
  else
    echo "Warning: Could not trigger CI automatically"
    echo "$COMMIT_RESPONSE" | jq

    exit 1
  fi
fi