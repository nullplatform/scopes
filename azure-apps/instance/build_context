#!/bin/bash
set -euo pipefail

# Extract all context fields in a single jq call
# CONTEXT = $NP_ACTION_CONTEXT.notification (set by main entrypoint)
eval "$(echo "$CONTEXT" | jq -r '
  "export SCOPE_ID=" + (.arguments.scope_id // .scope.id // "" | @sh) + "\n" +
  "export APPLICATION_ID=" + ((.arguments.application_id // .tags.application_id // "") | if type == "array" then .[0] else . end | @sh) + "\n" +
  "export DEPLOYMENT_ID=" + ((.arguments.deployment_id // "") | if type == "array" then .[0] else . end | @sh) + "\n" +
  "SCOPE_SLUG=" + (.scope.slug // "" | @sh) + "\n" +
  "NS_SLUG=" + (.tags.namespace // "" | @sh) + "\n" +
  "APP_SLUG=" + (.tags.application // "" | @sh) + "\n" +
  "SCOPE_NRN=" + (.scope.nrn // .entity_nrn // "" | @sh)
')"

export LIMIT=${LIMIT:-10}

# Use shared helper to resolve Azure context
# shellcheck source=../deployment/scripts/resolve_azure_context
source "$SERVICE_PATH/deployment/scripts/resolve_azure_context"
