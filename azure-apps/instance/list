#!/bin/bash
set -euo pipefail

# List Azure App Service instances via REST API

INSTANCES_URL="https://management.azure.com/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.Web/sites/${APP_NAME}/instances?api-version=2022-03-01"

INSTANCES=$(curl -s "$INSTANCES_URL" \
  -H "Authorization: Bearer ${AZURE_ACCESS_TOKEN}" \
  -H "Content-Type: application/json")

echo "$INSTANCES" | jq --argjson limit "${LIMIT:-10}" --arg app_name "$APP_NAME" '{
  results: (.value // [])[:$limit] | map({
    id: .name,
    selector: {
      scope_id: (env.SCOPE_ID // ""),
      application_id: (env.APPLICATION_ID // ""),
      deployment_id: (env.DEPLOYMENT_ID // "")
    },
    details: {
      namespace: (env.AZURE_RESOURCE_GROUP // ""),
      ip: "",
      dns: ($app_name + ".azurewebsites.net"),
      cpu: {
        requested: 0,
        limit: 0
      },
      memory: {
        requested: "0Mi",
        limit: "0Mi"
      },
      architecture: "x86"
    },
    state: (.properties.state // "Running"),
    launch_time: (.properties.siteInstanceName // ""),
    spot: false
  })
}'
