#!/bin/bash
set -euo pipefail

# Extract all context fields in a single jq call
# CONTEXT = $NP_ACTION_CONTEXT.notification (set by main entrypoint)
eval "$(echo "$CONTEXT" | jq -r '
  "export SCOPE_ID=" + ((.arguments.scope_id // .scope.id // "") | if type == "array" then .[0] else . end | tostring | @sh) + "\n" +
  "export METRIC_NAME=" + (.arguments.metric // "" | @sh) + "\n" +
  "export START_TIME=" + (.arguments.start_time // "" | @sh) + "\n" +
  "export END_TIME=" + (.arguments.end_time // "" | @sh) + "\n" +
  "export INTERVAL=" + (.arguments.interval // "5" | @sh) + "\n" +
  "SCOPE_SLUG=" + (.scope.slug // "" | @sh) + "\n" +
  "NS_SLUG=" + (.tags.namespace // "" | @sh) + "\n" +
  "APP_SLUG=" + (.tags.application // "" | @sh) + "\n" +
  "SCOPE_NRN=" + (.scope.nrn // .entity_nrn // "" | @sh)
')"

# Convert START_TIME and END_TIME from Unix ms to ISO format if numeric
if [ -n "$START_TIME" ] && [[ "$START_TIME" =~ ^[0-9]+$ ]]; then
  START_TIME=$(python3 -c "from datetime import datetime, timezone; print(datetime.fromtimestamp($START_TIME/1000, tz=timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'))")
  export START_TIME
fi
if [ -n "$END_TIME" ] && [[ "$END_TIME" =~ ^[0-9]+$ ]]; then
  END_TIME=$(python3 -c "from datetime import datetime, timezone; print(datetime.fromtimestamp($END_TIME/1000, tz=timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'))")
  export END_TIME
fi

# Use shared helper to resolve Azure context
# shellcheck source=../deployment/scripts/resolve_azure_context
source "$SERVICE_PATH/deployment/scripts/resolve_azure_context"

# Build Azure Resource ID
AZURE_RESOURCE_ID="/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.Web/sites/${APP_NAME}"
export AZURE_RESOURCE_ID
