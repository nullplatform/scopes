#!/bin/bash
set -euo pipefail

# Extract metric arguments from notification context
# CONTEXT = $NP_ACTION_CONTEXT.notification (set by main entrypoint)

SCOPE_ID=$(echo "$CONTEXT" | jq -r '.arguments.scope_id // .scope.id // empty')

if [ -z "$SCOPE_ID" ]; then
  echo "Error: Missing required parameter: scope_id" >&2
  exit 1
fi

# Export all arguments as uppercase env vars (same pattern as k8s)
while read -r line; do
  eval "$line"
done < <(echo "$CONTEXT" | jq -r '.arguments | to_entries[] |
  if (.value | type) == "array" then
    "export \(.key | ascii_upcase)=\(.value | join(","))"
  else
    "export \(.key | ascii_upcase)=\(.value)"
  end')

# Map METRIC to METRIC_NAME
if [ -n "${METRIC:-}" ]; then
  export METRIC_NAME="$METRIC"
fi

# Extract slugs directly from context (no np calls needed!)
SCOPE_SLUG=$(echo "$CONTEXT" | jq -r '.scope.slug // empty')
NS_SLUG=$(echo "$CONTEXT" | jq -r '.tags.namespace // empty')
APP_SLUG=$(echo "$CONTEXT" | jq -r '.tags.application // empty')
SCOPE_NRN=$(echo "$CONTEXT" | jq -r '.scope.nrn // .entity_nrn // empty')

if [ -z "$SCOPE_SLUG" ] || [ -z "$NS_SLUG" ] || [ -z "$APP_SLUG" ]; then
  echo "Error: Could not extract slugs from context" >&2
  exit 1
fi

# Generate Azure App Service name
APP_NAME=$("$SERVICE_PATH/deployment/scripts/generate_resource_name" 60 "$NS_SLUG" "$APP_SLUG" "$SCOPE_SLUG" "$SCOPE_ID")
export APP_NAME

# Fetch Azure credentials from cloud provider (still need this one np call)
PROVIDERS=$(np provider list --categories cloud-providers --nrn "$SCOPE_NRN" --format json)

export ARM_SUBSCRIPTION_ID=$(echo "$PROVIDERS" | jq -r '.results[0].attributes.authentication.subscription_id // empty')
export ARM_CLIENT_ID=$(echo "$PROVIDERS" | jq -r '.results[0].attributes.authentication.client_id // empty')
export ARM_TENANT_ID=$(echo "$PROVIDERS" | jq -r '.results[0].attributes.authentication.tenant_id // empty')
export AZURE_RESOURCE_GROUP=$(echo "$PROVIDERS" | jq -r '.results[0].attributes.networking.public_dns_zone_resource_group_name // empty')

if [ -z "$ARM_SUBSCRIPTION_ID" ] || [ -z "$ARM_CLIENT_ID" ] || [ -z "$ARM_TENANT_ID" ]; then
  echo "Error: Could not resolve Azure credentials from cloud-providers provider" >&2
  exit 1
fi

# Build Azure Resource ID
AZURE_RESOURCE_ID="/subscriptions/${ARM_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.Web/sites/${APP_NAME}"
export AZURE_RESOURCE_ID

# Authenticate with Azure
az login --service-principal -u "$ARM_CLIENT_ID" -p "$ARM_CLIENT_SECRET" --tenant "$ARM_TENANT_ID" --output none
az account set --subscription "$ARM_SUBSCRIPTION_ID" --output none

export SCOPE_ID
