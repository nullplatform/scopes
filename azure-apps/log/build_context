#!/bin/bash
set -euo pipefail

# Extract all context fields in a single jq call
NOTIFICATION=$(echo "$NP_ACTION_CONTEXT" | jq -c '.notification')
eval "$(echo "$NOTIFICATION" | jq -r '
  "export SCOPE_ID=" + ((.arguments.scope_id // .scope.id // "") | if type == "array" then .[0] else . end | tostring | @sh) + "\n" +
  "export APPLICATION_ID=" + ((.arguments.application_id // .tags.application_id // "") | if type == "array" then .[0] else . end | tostring | @sh) + "\n" +
  "export DEPLOYMENT_ID=" + ((.arguments.deployment_id // .scope.active_deployment // "") | if type == "array" then .[0] else . end | tostring | @sh) + "\n" +
  "export FILTER_PATTERN=" + (.arguments.filter_pattern // "" | @sh) + "\n" +
  "export INSTANCE_ID=" + (.arguments.instance_id // "" | @sh) + "\n" +
  "export LIMIT=" + (.arguments.limit // "" | @sh) + "\n" +
  "export START_TIME=" + (.arguments.start_time // "" | @sh) + "\n" +
  "export END_TIME=" + (.arguments.end_time // "" | @sh) + "\n" +
  "export NEXT_PAGE_TOKEN=" + (.arguments.next_page_token // "" | @sh) + "\n" +
  "SCOPE_SLUG=" + (.scope.slug // "" | @sh) + "\n" +
  "NS_SLUG=" + (.tags.namespace // "" | @sh) + "\n" +
  "APP_SLUG=" + (.tags.application // "" | @sh) + "\n" +
  "SCOPE_NRN=" + (.scope.nrn // .entity_nrn // "" | @sh)
')"

# Convert START_TIME and END_TIME from Unix ms to ISO format if numeric
if [ -n "$START_TIME" ] && [[ "$START_TIME" =~ ^[0-9]+$ ]]; then
  START_TIME=$(python3 -c "from datetime import datetime, timezone; print(datetime.fromtimestamp($START_TIME/1000, tz=timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'))")
  export START_TIME
fi
if [ -n "$END_TIME" ] && [[ "$END_TIME" =~ ^[0-9]+$ ]]; then
  END_TIME=$(python3 -c "from datetime import datetime, timezone; print(datetime.fromtimestamp($END_TIME/1000, tz=timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'))")
  export END_TIME
fi

# Use shared helper to resolve Azure context
# shellcheck source=../deployment/scripts/resolve_azure_context
source "$SERVICE_PATH/deployment/scripts/resolve_azure_context"
