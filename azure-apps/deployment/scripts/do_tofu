#!/bin/bash
set -euo pipefail

TOFU_ACTION="${TOFU_ACTION:-apply}"

echo "ğŸ“ Running tofu $TOFU_ACTION for deployment: $DEPLOYMENT_ID"
echo "ğŸ“‹ App Service: $APP_NAME"

TOFU_SOURCE="${TOFU_PATH:-$SERVICE_PATH/modules}"

# Copy tofu files to working directory
cp -r "$TOFU_SOURCE"/*.tf "$TF_WORKING_DIR/" 2>/dev/null || true
cp -r "$TOFU_SOURCE"/scripts "$TF_WORKING_DIR/" 2>/dev/null || true

# Generate tfvars from TOFU_VARIABLES
TOFU_VAR_FILE="$OUTPUT_DIR/tofu.tfvars.json"
echo "$TOFU_VARIABLES" > "$TOFU_VAR_FILE"

echo "ğŸ“‹ Generated tfvars:"
echo "$TOFU_VARIABLES" | jq .

# Run tofu
echo "ğŸ“ Initializing tofu..."
tofu -chdir="$TF_WORKING_DIR" init -input=false $TOFU_INIT_VARIABLES

echo "ğŸ“ Running tofu $TOFU_ACTION..."
tofu -chdir="$TF_WORKING_DIR" "$TOFU_ACTION" -auto-approve -var-file="$TOFU_VAR_FILE"

echo "âœ… Tofu $TOFU_ACTION completed successfully"
