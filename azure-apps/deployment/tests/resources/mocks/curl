#!/bin/bash
# Mock curl for unit tests
# Returns different responses based on URL patterns

if [ -n "${CURL_CALL_LOG:-}" ]; then
  echo "$*" >> "$CURL_CALL_LOG"
fi

# Check URL in arguments
ARGS="$*"

# Azure OAuth token endpoint
if [[ "$ARGS" == *"login.microsoftonline.com"*"oauth2"* ]]; then
  echo '{"access_token":"mock-azure-token","token_type":"Bearer","expires_in":3600}'
  exit 0
fi

# Azure publishing credentials endpoint
if [[ "$ARGS" == *"publishingcredentials"* ]]; then
  echo '{"properties":{"publishingUserName":"$mock-user","publishingPassword":"mock-password"}}'
  exit 0
fi

# Azure Monitor metrics endpoint
if [[ "$ARGS" == *"microsoft.insights/metrics"* ]]; then
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  cat "$SCRIPT_DIR/responses/az_metrics_cpu.json"
  exit 0
fi

# Azure App Service instances endpoint
if [[ "$ARGS" == *"/instances"* ]]; then
  # Check for mock response override first
  if [ -n "${CURL_MOCK_RESPONSE:-}" ] && [ -f "$CURL_MOCK_RESPONSE" ]; then
    cat "$CURL_MOCK_RESPONSE"
  else
    echo '{"value":[{"name":"instance1","properties":{"state":"Running"}},{"name":"instance2","properties":{"state":"Running"}}]}'
  fi
  exit 0
fi

# Default: return mock response file if configured
if [ -n "${CURL_MOCK_RESPONSE:-}" ] && [ -f "$CURL_MOCK_RESPONSE" ]; then
  cat "$CURL_MOCK_RESPONSE"
fi

exit "${CURL_MOCK_EXIT_CODE:-0}"
